<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>게시글 상세</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    body {
      padding: 40px;
      font-family: 'Pretendard', sans-serif;
      background-color: #f7faff;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    .comment-box {
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
<div class="container">
  <h3 id="boardTitle">제목</h3>
  <div class="text-muted mb-2" id="boardMeta">작성자 | 작성일 | 조회수</div>
  <hr>
  <div id="boardContent" style="min-height: 200px; padding: 12px 0;">내용</div>
  <hr>
  <div>
    <a href="/board" class="btn btn-secondary">목록으로</a>
    <a href="#" class="btn btn-primary" id="editBtn">수정</a>
    <button class="btn btn-danger" id="deleteBtn">삭제</button>
  </div>

  <!-- 댓글 작성 -->
  <div class="comment-box">
    <h5 class="mb-3">댓글 작성</h5>
    <form id="commentForm">
      <div class="mb-2">
        <textarea id="commentContent" class="form-control" rows="3" required placeholder="댓글을 입력하세요"></textarea>
      </div>
      <button type="submit" class="btn btn-sm btn-primary">작성</button>
    </form>
  </div>

  <!-- 댓글 목록 -->
  <div id="commentList" class="mt-4">
    <h5>댓글 목록</h5>
    <!-- JS로 채워짐 -->
  </div>
</div>

<script>
  const boardId = window.location.pathname.split("/").pop();

  $(document).ready(function () {
    // 게시글 상세 조회
    $.ajax({
      url: `/api/board/${boardId}`,
      method: 'GET',
      success: function (data) {
        $('#boardTitle').text(data.title);
        $('#boardMeta').text(`작성자: ${data.userName} | 작성일: ${data.createdAt.replace('T', ' ').substring(0, 16)} | 조회수: ${data.viewCount}`);
        $('#boardContent').text(data.content);
        $('#editBtn').attr('href', `/board/edit/${data.id}`);
      },
      error: function () {
        alert('게시글을 불러오지 못했습니다.');
        location.href = '/board';
      }
    });

    // 게시글 삭제
    $('#deleteBtn').click(function () {
      if (confirm('정말 삭제하시겠습니까?')) {
        $.ajax({
          url: `/api/board/${boardId}`,
          method: 'DELETE',
          success: function () {
            alert('삭제되었습니다.');
            window.location.href = '/board';
          },
          error: function () {
            alert('삭제에 실패했습니다.');
          }
        });
      }
    });

    // 댓글 작성
    $('#commentForm').on('submit', function (e) {
      e.preventDefault();
      const content = $('#commentContent').val();

      $.ajax({
        url: `/api/board/${boardId}/comments`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ content }),
        success: function () {
          $('#commentContent').val('');
          loadComments();
        },
        error: function () {
          alert('댓글 작성에 실패했습니다.');
        }
      });
    });

    // 댓글 목록 불러오기
    function loadComments() {
      $.ajax({
        url: `/api/board/${boardId}/comments`,
        method: 'GET',
        success: function (res) {
          const list = $('#commentList');
          list.empty();

          if (res.length === 0) {
            list.append('<p class="text-muted">댓글이 없습니다.</p>');
            return;
          }

          res.forEach(comment => {
            const commentHtml = `
              <div class="border rounded p-2 mb-2" data-id="${comment.id}">
                <div><strong>${comment.userName}</strong></div>
                <div class="comment-content">${comment.content}</div>
                <div class="text-muted small">${comment.createdAt.replace('T', ' ').substring(0, 16)}</div>
                ${comment.editable ? `
                  <button class="btn btn-sm btn-outline-secondary edit-btn mt-1">수정</button>
                  <button class="btn btn-sm btn-outline-danger delete-btn mt-1">삭제</button>
                ` : ''}
              </div>`;
            list.append(commentHtml);
          });
        },
        error: function () {
          $('#commentList').html('<p class="text-danger">댓글을 불러오지 못했습니다.</p>');
        }
      });
    }

    loadComments();

    // 댓글 수정
    $(document).on('click', '.edit-btn', function () {
      const commentDiv = $(this).closest('[data-id]');
      const id = commentDiv.data('id');
      const contentDiv = commentDiv.find('.comment-content');
      const originalContent = contentDiv.text();

      const textarea = $(`<textarea class="form-control mb-1" rows="2">${originalContent}</textarea>`);
      const saveBtn = $('<button class="btn btn-sm btn-primary me-1">저장</button>');
      const cancelBtn = $('<button class="btn btn-sm btn-secondary">취소</button>');

      contentDiv.replaceWith(textarea);
      $(this).after(cancelBtn).after(saveBtn);
      $(this).hide();

      saveBtn.click(function () {
        const newContent = textarea.val();

        $.ajax({
          url: `/api/board/${boardId}/comments/${id}`,
          method: 'PUT',
          contentType: 'application/json',
          data: JSON.stringify({ content: newContent }),
          success: function () {
            loadComments();
          },
          error: function () {
            alert('댓글 수정에 실패했습니다.');
          }
        });
      });

      cancelBtn.click(function () {
        textarea.replaceWith(`<div class="comment-content">${originalContent}</div>`);
        saveBtn.remove();
        cancelBtn.remove();
        commentDiv.find('.edit-btn').show();
      });
    });

    // 댓글 삭제
    $(document).on('click', '.delete-btn', function () {
      const commentDiv = $(this).closest('[data-id]');
      const id = commentDiv.data('id');

      if (confirm('댓글을 삭제하시겠습니까?')) {
        $.ajax({
          url: `/api/board/${boardId}/comments/${id}`,
          method: 'DELETE',
          success: function () {
            loadComments();
          },
          error: function () {
            alert('댓글 삭제에 실패했습니다.');
          }
        });
      }
    });
  });
</script>
</body>
</html>
