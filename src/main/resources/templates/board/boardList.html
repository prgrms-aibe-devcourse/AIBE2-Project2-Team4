<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>자유게시판</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/boardList.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
<div class="sidebar">
  <div class="menu">
    <a href="#" class="active">자유게시판</a>
    <a href="#">멘토링 신청</a>
    <a href="#">멘토링 후기</a>
  </div>
</div>

<div class="content">
  <h4 class="mb-4">자유게시판</h4>

  <!-- 필터 -->
  <div class="d-flex mb-3 gap-2 align-items-center justify-content-between">
    <div class="d-flex gap-2">
      <select class="form-select w-auto" id="jobTypeFilter">
        <option value="">직종</option>
        <option value="백엔드">백엔드</option>
        <option value="프론트엔드">프론트엔드</option>
        <option value="디자이너">디자이너</option>
        <option value="기획자">기획자</option>
      </select>

      <select class="form-select w-auto" id="techStackFilter">
        <option value="" disabled selected>기술스택</option>
      </select>
    </div>
    <button class="btn btn-outline-dark" onclick="openWriteForm()">글쓰기</button>
  </div>

  <!-- 검색 창 및 내 글 보기 -->
  <div class="d-flex mb-3 gap-2 align-items-center">
    <input type="text" id="keywordInput" class="form-control" placeholder="검색어를 입력하세요" style="max-width: 300px;">
    <button class="btn btn-dark" onclick="loadBoards()">검색</button>
    <button class="btn btn-outline-primary" onclick="loadMyBoards()">내 글 보기</button>
  </div>


  <!-- 게시글 리스트 -->
  <table class="table table-bordered text-center">
    <thead>
    <tr>
      <th style="width:5%">번호</th>
      <th style="width:10%">글쓴이</th>
      <th>제목</th>
      <th style="width:10%">직종</th>
      <th style="width:12%">기술</th>
      <th style="width:7%">조회수</th>
      <th style="width:15%">작성일</th>
    </tr>
    </thead>
    <tbody id="boardTableBody">
    <!-- Ajax로 채워짐 -->
    </tbody>
  </table>

  <!-- 페이징 -->
  <div id="pagination" class="d-flex justify-content-center mt-4"></div>
</div>

<!-- 글쓰기 모달 -->
<div class="overlay" id="overlay" style="display:none;"></div>
<div class="form-popup" id="writeForm" style="display:none; background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); max-width:600px; margin:auto;">
  <h5 class="mb-3">게시글 작성</h5>
  <form id="createForm">
    <div class="mb-3">
      <label class="form-label">제목</label>
      <input type="text" class="form-control" name="title" required>
    </div>
    <div class="mb-3">
      <label class="form-label">내용</label>
      <textarea class="form-control" name="content" rows="6" required></textarea>
    </div>
    <div class="mb-3">
      <label class="form-label">직종</label>
      <select class="form-select" name="jobType" id="jobTypeForm" required>
        <option value="">선택하세요</option>
        <option value="백엔드">백엔드</option>
        <option value="프론트엔드">프론트엔드</option>
        <option value="디자이너">디자이너</option>
        <option value="기획자">기획자</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">기술스택</label>
      <select class="form-select" name="techStack" id="techStackForm" required>
        <option value="">직종을 먼저 선택하세요</option>
      </select>
    </div>
    <div class="d-flex justify-content-end">
      <button type="button" class="btn btn-secondary me-2" onclick="closeWriteForm()">닫기</button>
      <button type="submit" class="btn btn-primary">등록</button>
    </div>
  </form>
</div>

<script>
  const techOptions = {
    "백엔드": ["Java", "Spring", "Spring Boot", "Node.js", "Express", "Python", "Django", "MySQL", "MongoDB"],
    "프론트엔드": ["HTML", "CSS", "JavaScript", "React", "Vue", "TypeScript", "Next.js"],
    "디자이너": ["Figma", "Photoshop", "Illustrator", "Sketch", "Adobe XD"],
    "기획자": ["Notion", "Jira", "Confluence", "Trello", "Excel"]
  };

  function updateTechStack(jobSelectId, techSelectId) {
    const job = document.getElementById(jobSelectId).value;
    const techSelect = document.getElementById(techSelectId);
    techSelect.innerHTML = '<option value="" disabled selected>기술스택</option>';
    if (techOptions[job]) {
      techOptions[job].forEach(stack => {
        const opt = document.createElement('option');
        opt.value = stack;
        opt.textContent = stack;
        techSelect.appendChild(opt);
      });
    }
  }

  $(document).ready(function () {
    loadBoards();

    $('#jobTypeFilter').on('change', function () {
      updateTechStack('jobTypeFilter', 'techStackFilter');
      loadBoards();
    });

    $('#techStackFilter').on('change', function(){
      if ($(this).val()) {
        loadBoards();
      }
    });

    $('#jobTypeForm').on('change', function () {
      updateTechStack('jobTypeForm', 'techStackForm');
    });
  });

  function loadBoards(page = 0) {
    const jobType = $('#jobTypeFilter').val();
    const techStack = $('#techStackFilter').val();
    const keyword = $('#keywordInput').val();

    $.ajax({
      url: '/api/board',
      type: 'GET',
      data: {
        page: page,
        size: 10,
        jobType: jobType,
        techStack: techStack,
        keyword: keyword
      },
      success: function (res) {
        renderBoardList(res);
        renderPagination(res);
      },
      error: function () {
        alert('게시글을 불러오지 못했습니다.');
      }
    });
  }

  //내 게시글 로드
  function loadMyBoards(page = 0) {
    $.ajax({
      url: '/api/board/my',
      type: 'GET',
      data: {
        page: page,
        size: 10
      },
      success: function (res) {
        renderBoardList(res);
        renderPagination(res, loadMyBoards); // 주의: 페이징 시에도 유지되도록
      },
      error: function () {
        alert('내 글을 불러오는 데 실패했습니다.');
      }
    });
  }



  function renderBoardList(res) {
    const tbody = $('#boardTableBody');
    tbody.empty();

    if (res.content.length === 0) {
      tbody.append('<tr><td colspan="7" class="text-muted">등록된 게시글이 없습니다.</td></tr>');
      return;
    }

    res.content.forEach((board, idx) => {
      const number = res.totalElements - (res.number * res.size) - idx;
      const row = `<tr data-id="${board.id}" style="cursor:pointer">
        <td>${board.id}</td>
        <td>${board.userName}</td>
        <td>${board.title}</td>
        <td>${board.jobType ?? '-'}</td>
        <td>${board.techStack ?? '-'}</td>
        <td>${board.viewCount}</td>
        <td>${board.createdAt.replace('T', ' ').substring(0, 16)}</td>
      </tr>`;
      tbody.append(row);
    });

    $('tr[data-id]').click(function () {
      const id = $(this).data('id');
      location.href = `/board/${id}`;
    });
  }

  function renderPagination(res) {
    const container = $('#pagination');
    container.empty();

    if (res.totalPages <= 1) return;

    const prevDisabled = res.first ? 'disabled' : '';
    const nextDisabled = res.last ? 'disabled' : '';

    container.append(`<button class="btn btn-sm mx-1 ${prevDisabled ? 'btn-secondary disabled' : 'btn-outline-secondary'}" ${prevDisabled ? 'disabled' : ''} onclick="loadBoards(${res.number - 1})">&laquo;</button>`);

    for (let i = 0; i < res.totalPages; i++) {
      const active = res.number === i ? 'btn-primary' : 'btn-outline-primary';
      container.append(`<button class="btn btn-sm mx-1 ${active}" onclick="loadBoards(${i})">${i + 1}</button>`);
    }

    container.append(`<button class="btn btn-sm mx-1 ${nextDisabled ? 'btn-secondary disabled' : 'btn-outline-secondary'}" ${nextDisabled ? 'disabled' : ''} onclick="loadBoards(${res.number + 1})">&raquo;</button>`);
  }

  function openWriteForm() {
    document.getElementById('overlay').style.display = 'block';
    document.getElementById('writeForm').style.display = 'block';
  }

  function closeWriteForm() {
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('writeForm').style.display = 'none';
  }

  <!-- 글 등록 POST-->
  $(document).on('submit', '#createForm', function (e) {
    e.preventDefault();

    const formData = {
      title: this.title.value,
      content: this.content.value,
      jobType: this.jobType.value,
      techStack: this.techStack.value
    };

    $.ajax({
      url: '/api/board',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(formData),
      success: function () {
        alert('게시글이 등록되었습니다.');
        closeWriteForm();
        loadBoards(); // 새로고침 없이 목록 갱신
      },
      error: function () {
        alert('게시글 등록 실패');
      }
    });
  });
</script>
</body>
</html>
