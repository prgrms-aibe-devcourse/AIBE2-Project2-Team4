<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>구직자 검색 - PortPilot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .search-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 0;
        }
        .search-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .result-card {
            transition: all 0.3s ease;
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .bookmark-btn {
            border: none;
            background: none;
            color: #dc3545;
            font-size: 1.2rem;
        }
        .bookmark-btn.bookmarked {
            color: #dc3545;
        }
        .stats-badge {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
        }
    </style>
</head>
<body>
<!-- 헤더 컴포넌트 (기존 헤더 사용) -->
<div th:replace="~{components/header :: header}"></div>

<!-- 검색 영역 -->
<div class="search-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="text-center mb-4">
                    <h1 class="display-4 fw-bold mb-3">
                        <i class="fas fa-search me-3"></i>구직자 검색
                    </h1>
                    <p class="lead">원하는 조건에 맞는 구직자를 찾아보세요</p>
                </div>

                <div class="search-card p-4">
                    <form th:action="@{/search/users}" method="get" th:object="${searchDto}">
                        <div class="row g-3">
                            <!-- 키워드 검색 -->
                            <div class="col-md-6">
                                <label for="keyword" class="form-label text-dark fw-bold">키워드</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="keyword"
                                           th:field="*{keyword}" placeholder="이름, 이메일, 기술 등을 검색하세요">
                                </div>
                            </div>

                            <!-- 지역 검색 -->
                            <div class="col-md-4">
                                <label for="location" class="form-label text-dark fw-bold">지역</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                    <input type="text" class="form-control" id="location"
                                           th:field="*{location}" placeholder="서울, 부산, 경기 등">
                                </div>
                            </div>

                            <!-- 검색 버튼 -->
                            <div class="col-md-2">
                                <label class="form-label text-dark fw-bold">&nbsp;</label>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-search me-2"></i>검색
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 경력 필터 -->
                        <div class="row g-3 mt-2">
                            <div class="col-md-3">
                                <label for="minExperience" class="form-label text-dark">최소 경력</label>
                                <select class="form-select" id="minExperience" th:field="*{minExperience}">
                                    <option value="">선택안함</option>
                                    <option value="0">신입</option>
                                    <option value="1">1년 이상</option>
                                    <option value="3">3년 이상</option>
                                    <option value="5">5년 이상</option>
                                    <option value="10">10년 이상</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label for="maxExperience" class="form-label text-dark">최대 경력</label>
                                <select class="form-select" id="maxExperience" th:field="*{maxExperience}">
                                    <option value="">선택안함</option>
                                    <option value="2">2년 이하</option>
                                    <option value="5">5년 이하</option>
                                    <option value="10">10년 이하</option>
                                    <option value="15">15년 이하</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label for="education" class="form-label text-dark">학력</label>
                                <select class="form-select" id="education" th:field="*{education}">
                                    <option value="">선택안함</option>
                                    <option value="고등학교">고등학교 졸업</option>
                                    <option value="전문대학">전문대학 졸업</option>
                                    <option value="대학교">대학교 졸업</option>
                                    <option value="대학원">대학원 졸업</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label for="sortBy" class="form-label text-dark">정렬</label>
                                <select class="form-select" id="sortBy" th:field="*{sortBy}">
                                    <option value="createdAt">최신순</option>
                                    <option value="name">이름순</option>
                                    <option value="experience">경력순</option>
                                </select>
                            </div>
                        </div>

                        <!-- 고급 검색 링크 -->
                        <div class="text-center mt-3">
                            <a th:href="@{/search/users/advanced}" class="btn btn-outline-secondary">
                                <i class="fas fa-sliders-h me-2"></i>고급 검색
                            </a>
                            <a th:href="@{/search/users/saved}" class="btn btn-outline-info ms-2">
                                <i class="fas fa-bookmark me-2"></i>저장된 검색
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 검색 결과 영역 -->
<div class="container my-5" th:if="${hasResults}">
    <!-- 검색 결과 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold mb-1">검색 결과</h3>
            <p class="text-muted mb-0">
                총 <span class="badge stats-badge" th:text="${totalResults}">0</span>명의 구직자를 찾았습니다
            </p>
        </div>

        <!-- 검색 조건 저장 버튼 -->
        <div>
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#saveSearchModal">
                <i class="fas fa-save me-2"></i>검색 조건 저장
            </button>
        </div>
    </div>

    <!-- 검색 결과 리스트 -->
    <div class="row g-4">
        <div class="col-lg-6" th:each="user : ${searchResults.content}">
            <div class="card result-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3"
                                 style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-1" th:text="${user.name}">홍길동</h5>
                                <p class="text-muted mb-0" th:text="${user.email}">hong@example.com</p>
                            </div>
                        </div>

                        <!-- 북마크 버튼 -->
                        <button type="button" class="bookmark-btn"
                                th:classappend="${user.bookmarked} ? 'bookmarked' : ''"
                                th:onclick="'toggleBookmark(' + ${user.id} + ', \'USER\', this)'">
                            <i th:class="${user.bookmarked} ? 'fas fa-heart' : 'far fa-heart'"></i>
                        </button>
                    </div>

                    <div class="mb-3">
                        <p class="card-text">
                            <i class="fas fa-map-marker-alt text-muted me-2"></i>
                            <span th:text="${user.address}">서울시 강남구</span>
                        </p>

                        <!-- 스킬 태그 (UserProfile 연동 후 표시) -->
                        <div class="mb-2" th:if="${user.skills != null and not #lists.isEmpty(user.skills)}">
                            <span class="badge bg-secondary me-1" th:each="skill : ${user.skills}" th:text="${skill}">Java</span>
                        </div>

                        <!-- 경력 정보 -->
                        <p class="text-muted small mb-2" th:if="${user.experience != null}">
                            <i class="fas fa-briefcase me-2"></i>
                            경력 <span th:text="${user.experience}">3</span>년
                        </p>

                        <!-- 가입일 -->
                        <p class="text-muted small mb-0">
                            <i class="fas fa-calendar me-2"></i>
                            가입일: <span th:text="${#temporals.format(user.createdAt, 'yyyy-MM-dd')}">2024-01-01</span>
                        </p>
                    </div>

                    <div class="d-flex justify-content-end">
                        <a th:href="@{'/users/' + ${user.id}}" class="btn btn-outline-primary btn-sm me-2">
                            <i class="fas fa-eye me-1"></i>프로필 보기
                        </a>
                        <button type="button" class="btn btn-primary btn-sm">
                            <i class="fas fa-envelope me-1"></i>연락하기
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 페이지네이션 -->
    <nav aria-label="검색 결과 페이지네이션" class="mt-5" th:if="${searchResults.totalPages > 1}">
        <ul class="pagination justify-content-center">
            <!-- 이전 페이지 -->
            <li class="page-item" th:classappend="${searchResults.first} ? 'disabled'">
                <a class="page-link" th:href="@{/search/users(keyword=${searchDto.keyword}, location=${searchDto.location}, minExperience=${searchDto.minExperience}, maxExperience=${searchDto.maxExperience}, education=${searchDto.education}, sortBy=${searchDto.sortBy}, page=${currentPage - 1})}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>

            <!-- 페이지 번호들 -->
            <li class="page-item" th:each="pageNum : ${#numbers.sequence(0, searchResults.totalPages - 1)}"
                th:classappend="${pageNum == currentPage} ? 'active'">
                <a class="page-link" th:text="${pageNum + 1}"
                   th:href="@{/search/users(keyword=${searchDto.keyword}, location=${searchDto.location}, minExperience=${searchDto.minExperience}, maxExperience=${searchDto.maxExperience}, education=${searchDto.education}, sortBy=${searchDto.sortBy}, page=${pageNum})}">1</a>
            </li>

            <!-- 다음 페이지 -->
            <li class="page-item" th:classappend="${searchResults.last} ? 'disabled'">
                <a class="page-link" th:href="@{/search/users(keyword=${searchDto.keyword}, location=${searchDto.location}, minExperience=${searchDto.minExperience}, maxExperience=${searchDto.maxExperience}, education=${searchDto.education}, sortBy=${searchDto.sortBy}, page=${currentPage + 1})}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        </ul>
    </nav>
</div>

<!-- 검색 결과 없음 -->
<div class="container my-5 text-center" th:if="${hasResults != null and !hasResults}">
    <div class="py-5">
        <i class="fas fa-search-minus text-muted" style="font-size: 4rem;"></i>
        <h3 class="mt-3 text-muted">검색 결과가 없습니다</h3>
        <p class="text-muted">다른 검색 조건으로 다시 시도해보세요.</p>
    </div>
</div>

<!-- 검색 조건 저장 모달 -->
<div class="modal fade" id="saveSearchModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">검색 조건 저장</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form th:action="@{/search/users/save}" method="post" th:object="${searchDto}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="searchName" class="form-label">검색 조건 이름</label>
                        <input type="text" class="form-control" id="searchName" name="name"
                               placeholder="예: 서울 백엔드 개발자" required>
                    </div>

                    <!-- 숨겨진 검색 조건들 -->
                    <input type="hidden" th:field="*{keyword}">
                    <input type="hidden" th:field="*{location}">
                    <input type="hidden" th:field="*{minExperience}">
                    <input type="hidden" th:field="*{maxExperience}">
                    <input type="hidden" th:field="*{education}">
                    <input type="hidden" th:field="*{sortBy}">
                    <input type="hidden" th:field="*{sortDirection}">

                    <div class="alert alert-info">
                        <h6>저장될 검색 조건:</h6>
                        <ul class="mb-0">
                            <li th:if="${searchDto.keyword != null and !#strings.isEmpty(searchDto.keyword)}">
                                키워드: <strong th:text="${searchDto.keyword}"></strong>
                            </li>
                            <li th:if="${searchDto.location != null and !#strings.isEmpty(searchDto.location)}">
                                지역: <strong th:text="${searchDto.location}"></strong>
                            </li>
                            <li th:if="${searchDto.minExperience != null}">
                                최소 경력: <strong th:text="${searchDto.minExperience} + '년'"></strong>
                            </li>
                            <li th:if="${searchDto.maxExperience != null}">
                                최대 경력: <strong th:text="${searchDto.maxExperience} + '년'"></strong>
                            </li>
                            <li th:if="${searchDto.education != null and !#strings.isEmpty(searchDto.education)}">
                                학력: <strong th:text="${searchDto.education}"></strong>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- 북마크 토글 스크립트 -->
<script>
    function toggleBookmark(targetId, targetType, buttonElement) {
        fetch('/bookmarks/toggle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: new URLSearchParams({
                'targetId': targetId,
                'targetType': targetType
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const icon = buttonElement.querySelector('i');
                    if (data.bookmarked) {
                        icon.className = 'fas fa-heart';
                        buttonElement.classList.add('bookmarked');
                    } else {
                        icon.className = 'far fa-heart';
                        buttonElement.classList.remove('bookmarked');
                    }
                } else {
                    alert('북마크 처리 중 오류가 발생했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('북마크 처리 중 오류가 발생했습니다.');
            });
    }
</script>
</body>
</html>