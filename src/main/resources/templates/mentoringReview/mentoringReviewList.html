<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>멘토링 후기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background-color: #f7faff;
            font-family: 'Pretendard', sans-serif;
            margin: 0;
        }

        .sidebar {
            width: 220px;
            height: 100vh;
            background-color: #29459A;
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 40px;
        }

        .sidebar a {
            display: block;
            padding: 15px 25px;
            text-decoration: none;
            color: white;
            font-weight: 500;
            margin: 0;
            border-radius: 0;
        }

        .sidebar a.active,
        .sidebar a:hover {
            background-color: white;
            color: #29459A;
        }

        .content {
            margin-left: 220px;
            padding: 40px 20px;
            background-color: #f7faff;
            min-height: 100vh;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            border: none;
            padding: 12px;
            white-space: nowrap;
        }

        .table td {
            padding: 12px;
            border: none;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
            white-space: nowrap;
        }

        .table tbody tr:hover {
            background-color: #f0f4ff;
            cursor: pointer;
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        .star-rating {
            color: #ffc107;
            font-size: 1.1rem;
        }

        .star-rating .star {
            color: #ddd;
        }

        .star-rating .star.filled {
            color: #ffc107;
        }

        .title-cell {
            white-space: normal;
            max-width: 300px;
        }

        .review-title {
            font-weight: 500;
            color: #333;
        }

        .pagination .page-link {
            color: #29459A;
            border-color: #dee2e6;
        }

        .pagination .page-item.active .page-link {
            background-color: #29459A;
            border-color: #29459A;
        }

        .pagination .page-link:hover {
            color: #29459A;
            background-color: #e9ecef;
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="menu">
        <a href="/mentoring">멘토링 신청</a>
        <a href="/mentoringReview" class="active">멘토링 후기</a>
        <a href="/study">스터디 만들기</a>
        <a href="/board">자유게시판</a>
    </div>
</div>

<div class="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>멘토링 후기</h3>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="loadReviews()">전체 보기</button>
            <button class="btn btn-outline-secondary" onclick="loadMyReceivedReviews()">내가 받은 후기</button>
            <button class="btn btn-outline-secondary" onclick="loadMyWrittenReviews()">내가 작성한 후기</button>
            <a href="/mentoringReview/write" class="btn btn-outline-primary">후기 작성하기</a>
        </div>
    </div>

    <div id="review-content">
        <div class="card">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                <tr>
                    <th style="width: 60px;">번호</th>
                    <th style="width: 100px;">글쓴이</th>
                    <th style="width: 100px;">멘토명</th>
                    <th style="width: 350px;">제목</th>
                    <th style="width: 100px;">평점</th>
                    <th style="width: 70px;">조회수</th>
                    <th style="width: 110px;">작성일</th>
                </tr>
                </thead>
                <tbody id="reviewTableBody">
                <tr>
                    <td colspan="7" class="text-center">
                        <div class="spinner-border spinner-border-sm me-2"></div>
                        로딩 중...
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div id="pagination" class="d-flex justify-content-center mt-4" style="display: none !important;">
            <nav>
                <ul class="pagination">
                    <li class="page-item" id="prevPage">
                        <a class="page-link" href="#" onclick="loadPage(currentPage - 1)">이전</a>
                    </li>
                    <div id="pageNumbers" class="d-flex"></div>
                    <li class="page-item" id="nextPage">
                        <a class="page-link" href="#" onclick="loadPage(currentPage + 1)">다음</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<script>
    let currentPage = 0;
    let totalPages = 0;
    let pageSize = 10;

    document.addEventListener('DOMContentLoaded', () => {
        loadReviews();
    });

    function loadReviews(page = 0) {
        currentPage = page;
        const tbody = document.getElementById('reviewTableBody');

        tbody.innerHTML = `
        <tr>
            <td colspan="7" class="text-center">
                <div class="spinner-border spinner-border-sm me-2"></div>
                로딩 중...
            </td>
        </tr>
    `;

        fetch(`/api/mentoring-review/paged?page=${page}&size=${pageSize}`)
            .then(res => res.json())
            .then(data => {
                tbody.innerHTML = '';
                totalPages = data.totalPages || 0;
                const reviews = Array.isArray(data.reviews) ? data.reviews : [];

                if (reviews.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            아직 작성된 후기가 없습니다.
                        </td>
                    </tr>
                `;
                    return;
                }

                reviews.forEach((review, index) => {
                    const stars = generateStarRating(review.rating);
                    const globalIndex = data.totalElements
                        ? data.totalElements - (page * pageSize) - index
                        : index + 1;

                    const row = document.createElement('tr');
                    row.style.cursor = 'pointer';
                    row.onclick = () => viewReview(review.id);

                    row.innerHTML = `
                    <td class="text-center">${globalIndex}</td>
                    <td>${review.reviewerName || '-'}</td>
                    <td>${review.mentorName || '-'}</td>
                    <td class="title-cell"><div class="review-title">${review.title}</div></td>
                    <td><div class="star-rating">${stars}</div></td>
                    <td class="text-center">${review.viewCount}</td>
                    <td>${formatDate(review.createdAt)}</td>
                `;
                    tbody.appendChild(row);
                });

                updatePagination();
            })
            .catch(showError);
    }

    function loadMyReceivedReviews() {
        fetch(`/api/mentoring-review/mentor/me`)
            .then(res => res.json())
            .then(data => renderReviewList(data))
            .catch(showError);
    }

    function loadMyWrittenReviews() {
        fetch(`/api/mentoring-review/mentee/me`)
            .then(res => res.json())
            .then(data => renderReviewList(data))
            .catch(showError);
    }

    function renderReviewList(reviews) {
        const tbody = document.getElementById('reviewTableBody');
        const pagination = document.getElementById('pagination');
        tbody.innerHTML = '';
        pagination.style.display = 'none';

        if (!Array.isArray(reviews) || reviews.length === 0) {
            tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    후기가 없습니다.
                </td>
            </tr>
        `;
            return;
        }

        reviews.forEach((review, index) => {
            const stars = generateStarRating(review.rating);
            const row = document.createElement('tr');
            row.onclick = () => viewReview(review.id);

            row.innerHTML = `
            <td class="text-center">${index + 1}</td>
            <td>${review.reviewerName || '-'}</td>
            <td>${review.mentorName || '-'}</td>
            <td class="title-cell"><div class="review-title">${review.title}</div></td>
            <td><div class="star-rating">${stars}</div></td>
            <td class="text-center">${review.viewCount}</td>
            <td>${formatDate(review.createdAt)}</td>
        `;
            tbody.appendChild(row);
        });
    }

    function updatePagination() {
        const pagination = document.getElementById('pagination');
        const pageNumbers = document.getElementById('pageNumbers');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');

        if (totalPages <= 1) {
            pagination.style.display = 'none';
            return;
        }

        pagination.style.display = 'flex';
        prevPage.classList.toggle('disabled', currentPage === 0);
        nextPage.classList.toggle('disabled', currentPage === totalPages - 1);

        pageNumbers.innerHTML = '';
        const startPage = Math.max(0, currentPage - 2);
        const endPage = Math.min(totalPages - 1, currentPage + 2);

        for (let i = startPage; i <= endPage; i++) {
            const pageItem = document.createElement('li');
            pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;

            const pageLink = document.createElement('a');
            pageLink.className = 'page-link';
            pageLink.href = '#';
            pageLink.textContent = i + 1;
            pageLink.onclick = (e) => {
                e.preventDefault();
                loadPage(i);
            };

            pageItem.appendChild(pageLink);
            pageNumbers.appendChild(pageItem);
        }
    }

    function loadPage(page) {
        if (page < 0 || page >= totalPages) return;
        loadReviews(page);
    }

    function generateStarRating(rating) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
            stars += `<span class="star ${i <= rating ? 'filled' : ''}">★</span>`;
        }
        return stars;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('ko-KR', {
            month: '2-digit',
            day: '2-digit'
        });
    }

    function viewReview(reviewId) {
        window.location.href = `/mentoringReview/detail?id=${reviewId}`;
    }

    function showError(err) {
        const tbody = document.getElementById('reviewTableBody');
        tbody.innerHTML = `
        <tr>
            <td colspan="7" class="text-center text-danger">
                오류 발생: ${err.message}
            </td>
        </tr>
    `;
    }
</script>
</body>
</html>
