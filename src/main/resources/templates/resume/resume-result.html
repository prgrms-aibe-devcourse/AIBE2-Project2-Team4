<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>ÏûêÏÜåÏÑú Í≤∞Í≥º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f8f9fa;
      line-height: 1.6;
    }

    .header {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .btn-secondary {
      padding: 0.5rem 1rem;
      background: transparent;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      color: #374151;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
    }

    .btn-secondary:hover {
      background: #f9fafb;
    }

    .btn-primary {
      padding: 0.5rem 1rem;
      background: #059669;
      border: 1px solid #059669;
      border-radius: 0.375rem;
      color: white;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
    }

    .btn-primary:hover {
      background: #047857;
    }

    .btn-primary:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      gap: 2rem;
      padding: 2rem;
      min-height: calc(100vh - 100px);
    }

    /* ÏôºÏ™Ω ÏÇ¨Ïù¥ÎìúÎ∞î */
    .sidebar {
      width: 280px;
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      height: fit-content;
      position: sticky;
      top: 120px;
    }

    .sidebar-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .section-nav {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .nav-item {
      padding: 0.75rem 1rem;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.875rem;
      font-weight: 500;
      color: #6b7280;
      border: 1px solid transparent;
    }

    .nav-item:hover {
      background: #f3f4f6;
      color: #374151;
    }

    .nav-item.active {
      background: #eff6ff;
      color: #2563eb;
      border-color: #dbeafe;
    }

    /* Î©îÏù∏ ÏΩòÌÖêÏ∏† ÏòÅÏó≠ */
    .main-content {
      flex: 1;
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      display: flex;
      flex-direction: column;
    }

    .content-header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .content-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }

    .content-subtitle {
      font-size: 0.875rem;
      color: #6b7280;
    }

    .section {
      display: none;
      flex-direction: column;
      height: 100%;
    }

    .section.active {
      display: flex;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 1.5rem;
    }

    .editor-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .content-textarea {
      width: 100%;
      min-height: 500px;
      height: 60vh;
      padding: 1.5rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      background: white;
      font-size: 1rem;
      line-height: 1.7;
      color: #374151;
      resize: vertical;
      font-family: inherit;
      flex: 1;
    }

    .content-textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .editor-footer {
      display: flex;
      justify-content: stretch;
      align-items: center;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #f3f4f6;
    }

    .char-count {
      font-size: 0.875rem;
      color: #6b7280;
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0 1.5rem;
      flex: 1;
    }

    .char-count-text {
      white-space: nowrap;
      font-weight: 500;
    }

    .progress-bar {
      flex: 1;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #3b82f6;
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 3rem;
      color: #6b7280;
      flex: 1;
      align-items: center;
      justify-content: center;
    }

    .loading.show {
      display: flex;
    }

    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 1s ease-in-out infinite;
      margin-right: 0.75rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      display: none;
      text-align: center;
      padding: 3rem 2rem;
      color: #6b7280;
      flex: 1;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .empty-state.show {
      display: flex;
    }

    .empty-state .icon {
      font-size: 4rem;
      margin-bottom: 1.5rem;
      opacity: 0.5;
    }

    .error-message {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #b91c1c;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }

    /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
        padding: 1rem;
      }

      .sidebar {
        width: 100%;
        position: static;
      }

      .section-nav {
        flex-direction: row;
        overflow-x: auto;
        gap: 0.25rem;
      }

      .nav-item {
        white-space: nowrap;
        flex-shrink: 0;
      }

      .content-textarea {
        min-height: 400px;
        height: 50vh;
      }
    }

    /* ÏûêÎèô Ï†ÄÏû• ÌëúÏãú */
    .auto-save-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #059669;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }

    .auto-save-indicator.show {
      opacity: 1;
    }

    /* ÌååÏùº Ï†ÄÏû• Î™®Îã¨ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 0.5rem;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .export-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 2rem;
    }

    .export-option {
      display: flex;
      align-items: center;
      padding: 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .export-option:hover {
      border-color: #3b82f6;
      background: #f8faff;
    }

    .export-option.selected {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .export-option input[type="radio"] {
      margin-right: 0.75rem;
    }

    .export-info {
      flex: 1;
    }

    .export-info h4 {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.25rem;
    }

    .export-info p {
      font-size: 0.875rem;
      color: #6b7280;
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    .btn-cancel {
      padding: 0.5rem 1rem;
      background: transparent;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      color: #374151;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-cancel:hover {
      background: #f9fafb;
    }

    .btn-export {
      padding: 0.5rem 1rem;
      background: #3b82f6;
      border: 1px solid #3b82f6;
      border-radius: 0.375rem;
      color: white;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-export:hover {
      background: #2563eb;
    }

    .btn-export:disabled {
      background: #9ca3af;
      border-color: #9ca3af;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
<div class="header">
  <div class="header-content">
    <div class="header-actions">
      <a href="/resumes" class="btn-secondary">‚Üê Î™©Î°ùÏúºÎ°ú</a>
    </div>
    <div class="header-actions">
      <button class="btn-secondary" onclick="showExportModal()" id="exportBtn">üìÑ ÌååÏùºÎ°ú Ï†ÄÏû•</button>
      <button class="btn-primary" onclick="saveContent()" id="headerSaveBtn">üíæ Ï†ÄÏû•ÌïòÍ∏∞</button>
    </div>
  </div>
</div>

<!-- ÏûêÎèô Ï†ÄÏû• ÌëúÏãú -->
<div id="autoSaveIndicator" class="auto-save-indicator">
  ‚úÖ ÏûêÎèô Ï†ÄÏû•Îê®
</div>

<!-- ÌååÏùº Ï†ÄÏû• Î™®Îã¨ -->
<div id="exportModal" class="modal-overlay" onclick="closeExportModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-title">ÌååÏùºÎ°ú Ï†ÄÏû•ÌïòÍ∏∞</div>

    <div class="export-options">
      <label class="export-option" onclick="selectExportOption('pdf')">
        <input type="radio" name="exportType" value="pdf">
        <div class="export-info">
          <h4>üìÑ PDF ÌååÏùº</h4>
          <p>Ïù∏ÏáÑÏö©ÏúºÎ°ú Ï†ÅÌï©Ìïú PDF ÌòïÏãù</p>
        </div>
      </label>

      <label class="export-option" onclick="selectExportOption('docx')">
        <input type="radio" name="exportType" value="docx">
        <div class="export-info">
          <h4>üìù Word Î¨∏ÏÑú</h4>
          <p>Ìé∏Ïßë Í∞ÄÎä•Ìïú Word Î¨∏ÏÑú (DOCX)</p>
        </div>
      </label>

      <label class="export-option" onclick="selectExportOption('txt')">
        <input type="radio" name="exportType" value="txt">
        <div class="export-info">
          <h4>üìã ÌÖçÏä§Ìä∏ ÌååÏùº</h4>
          <p>ÏàúÏàò ÌÖçÏä§Ìä∏ ÌòïÏãù (TXT)</p>
        </div>
      </label>
    </div>

    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeExportModal()">Ï∑®ÏÜå</button>
      <button class="btn-export" onclick="exportFile()" id="exportConfirmBtn" disabled>ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
    </div>
  </div>
</div>

<div class="container">
  <!-- ÏôºÏ™Ω ÏÇ¨Ïù¥ÎìúÎ∞î -->
  <div class="sidebar">
    <div class="sidebar-title" id="resumeTitle">ÏûêÍ∏∞ÏÜåÍ∞úÏÑú</div>
    <div class="section-nav" id="sectionNavigation">
      <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê† ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Ìï≠Î™©Îì§ -->
    </div>
  </div>

  <!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† ÏòÅÏó≠ -->
  <div class="main-content">
    <div id="loadingSection" class="loading">
      <div class="spinner"></div>
      ÏûêÏÜåÏÑúÎ•º ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...
    </div>

    <div id="contentSection">
      <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê† ÏÑπÏÖòÎì§ -->
    </div>

    <div id="emptyState" class="empty-state">
      <div class="icon">üìù</div>
      <h3>ÏûêÏÜåÏÑúÎ•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§</h3>
      <p>Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.</p>
    </div>
  </div>
</div>

<script>
  let resumeId = null;
  let currentSections = [];
  let autoSaveInterval = null;
  let selectedExportType = null;

  // SectionType Îß§Ìïë
  const sectionTypeMapping = {
    'GROWTH': 'ÏÑ±Ïû•Í≥ºÏ†ï',
    'PERSONALITY': 'ÏÑ±Í≤©Ïùò Ïû•Îã®Ï†ê',
    'MOTIVATION': 'ÏßÄÏõêÎèôÍ∏∞',
    'GOALS': 'ÏûÖÏÇ¨ ÌõÑ Ìè¨Î∂Ä',
    'ASPIRATION': 'ÏûÖÏÇ¨ ÌõÑ Ìè¨Î∂Ä',
    'PROJECT': 'ÌîÑÎ°úÏ†ùÌä∏ Í≤ΩÌóò',
    'STRENGTH': 'Í∞ïÏ†ê',
    'EXPERIENCE': 'Í≤ΩÌóò/ÌôúÎèô',
    'GOAL': 'Î™©Ìëú',
    'OTHER': 'Í∏∞ÌÉÄ'
  };

  // Í∏∞Î≥∏ Í∏ÄÏûêÏàò Ï†úÌïú
  const defaultCharLimit = 1000;

  // URLÏóêÏÑú resumeId ÌååÎùºÎØ∏ÌÑ∞ Ï∂îÏ∂ú
  function getResumeIdFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('resumeId');
  }

  // CSRF ÌÜ†ÌÅ∞ Í∞ÄÏ†∏Ïò§Í∏∞
  function getCSRFHeaders() {
    const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

    const headers = {
      'Content-Type': 'application/json'
    };

    if (token && header) {
      headers[header] = token;
    }

    return headers;
  }

  // ÌéòÏù¥ÏßÄ Î°úÎìúÏãú ÏûêÏÜåÏÑú Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞
  async function loadResumeData() {
    resumeId = getResumeIdFromUrl();
    if (!resumeId) {
      showError('Resume IDÍ∞Ä ÏóÜÏäµÎãàÎã§.');
      return;
    }

    try {
      showLoading();

      const response = await fetch(`/gemini/result/${resumeId}`, {
        method: 'GET',
        headers: getCSRFHeaders()
      });

      if (response.ok) {
        const resumeData = await response.json();
        displayResumeData(resumeData);
      } else {
        const errorText = await response.text();
        throw new Error(`ÏûêÏÜåÏÑú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. ${errorText}`);
      }
    } catch (error) {
      console.error('Load error:', error);
      showError(error.message);
    }
  }

  // Î°úÎî© ÏÉÅÌÉú ÌëúÏãú
  function showLoading() {
    document.getElementById('loadingSection').classList.add('show');
    document.getElementById('contentSection').style.display = 'none';
    document.getElementById('emptyState').classList.remove('show');
  }

  // ÏûêÏÜåÏÑú Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
  function displayResumeData(resumeData) {
    document.getElementById('loadingSection').classList.remove('show');
    document.getElementById('emptyState').classList.remove('show');
    document.getElementById('contentSection').style.display = 'block';

    // Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
    document.getElementById('resumeTitle').textContent = resumeData.title || 'ÏûêÍ∏∞ÏÜåÍ∞úÏÑú';

    // ÏÑπÏÖò Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
    currentSections = resumeData.sections || [];

    if (currentSections.length === 0) {
      showEmptySection();
      return;
    }

    // ÏÇ¨Ïù¥ÎìúÎ∞î ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏÉùÏÑ±
    createSectionNavigation();

    // ÏÑπÏÖò ÏΩòÌÖêÏ∏† ÏÉùÏÑ±
    createSectionContents();

    // ÏûêÎèô Ï†ÄÏû• ÏãúÏûë
    startAutoSave();
  }

  // Îπà ÏÑπÏÖò ÌëúÏãú
  function showEmptySection() {
    const emptyState = document.getElementById('emptyState');
    emptyState.classList.add('show');
    emptyState.innerHTML = `
      <div class="icon">üìù</div>
      <h3>ÏÉùÏÑ±Îêú ÏûêÏÜåÏÑú ÏÑπÏÖòÏù¥ ÏóÜÏäµÎãàÎã§</h3>
      <p>ÏûêÏÜåÏÑú ÏÉùÏÑ±ÏùÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.</p>
    `;
  }

  // ÏÇ¨Ïù¥ÎìúÎ∞î ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏÉùÏÑ±
  function createSectionNavigation() {
    const sectionNavigation = document.getElementById('sectionNavigation');
    sectionNavigation.innerHTML = '';

    currentSections.forEach((section, index) => {
      const sectionType = section.section_type || section.sectionType;

      if (!sectionType) {
        console.warn('Section without sectionType found:', section);
        return;
      }

      const sectionTitle = sectionTypeMapping[sectionType] || sectionType;
      const navItem = document.createElement('div');
      navItem.className = `nav-item ${index === 0 ? 'active' : ''}`;
      navItem.textContent = sectionTitle;
      navItem.onclick = () => switchSection(sectionType, navItem);
      sectionNavigation.appendChild(navItem);
    });
  }

  // ÏÑπÏÖò ÏΩòÌÖêÏ∏† ÏÉùÏÑ±
  function createSectionContents() {
    const contentSection = document.getElementById('contentSection');
    contentSection.innerHTML = '';

    currentSections.forEach((section, index) => {
      const sectionType = section.section_type || section.sectionType;

      if (!sectionType) {
        console.warn('Section without sectionType found:', section);
        return;
      }

      const sectionTitle = sectionTypeMapping[sectionType] || sectionType;
      const sectionId = sectionType.toLowerCase();

      const sectionDiv = document.createElement('div');
      sectionDiv.className = `section ${index === 0 ? 'active' : ''}`;
      sectionDiv.id = `section-${sectionId}`;

      sectionDiv.innerHTML = `
        <div class="content-header">
          <div class="content-title">${sectionTitle}</div>
          <div class="content-subtitle">${sectionTitle}Ïóê ÎåÄÌïú ÏûêÏÑ∏Ìïú ÎÇ¥Ïö©ÏùÑ ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.</div>
        </div>

        <div class="editor-container">
          <textarea
            class="content-textarea"
            id="${sectionId}Content"
            placeholder="${sectionTitle} ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
            oninput="updateCharCount('${sectionId}Content', '${sectionId}Count', ${defaultCharLimit})"
          >${section.content || ''}</textarea>

          <div class="editor-footer">
            <div class="char-count">
              <span class="char-count-text">
                <span id="${sectionId}Count">0</span> / ${defaultCharLimit}
              </span>
              <div class="progress-bar">
                <div class="progress-fill" id="${sectionId}Progress" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
      `;

      contentSection.appendChild(sectionDiv);

      // Ï¥àÍ∏∞ Í∏ÄÏûêÏàò Ïπ¥Ïö¥Ìä∏
      setTimeout(() => {
        updateCharCount(`${sectionId}Content`, `${sectionId}Count`, defaultCharLimit);
      }, 100);
    });
  }

  // ÏÑπÏÖò Ï†ÑÌôò
  function switchSection(sectionType, clickedNav) {
    // Î™®Îì† ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÎπÑÌôúÏÑ±Ìôî
    document.querySelectorAll('.nav-item').forEach(nav => {
      nav.classList.remove('active');
    });

    // Î™®Îì† ÏÑπÏÖò Ïà®Í∏∞Í∏∞
    document.querySelectorAll('.section').forEach(section => {
      section.classList.remove('active');
    });

    // ÏÑ†ÌÉùÎêú ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÌôúÏÑ±Ìôî
    clickedNav.classList.add('active');

    // ÏÑ†ÌÉùÎêú ÏÑπÏÖò ÌëúÏãú
    const sectionId = sectionType.toLowerCase();
    const sectionElement = document.getElementById(`section-${sectionId}`);
    if (sectionElement) {
      sectionElement.classList.add('active');
    }
  }

  // ÏóêÎü¨ ÏÉÅÌÉú ÌëúÏãú
  function showError(message) {
    document.getElementById('loadingSection').classList.remove('show');
    document.getElementById('contentSection').style.display = 'none';

    const emptyState = document.getElementById('emptyState');
    emptyState.classList.add('show');
    emptyState.innerHTML = `
      <div class="icon">‚ö†Ô∏è</div>
      <h3>Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</h3>
      <p>${message}</p>
      <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 0.375rem; cursor: pointer;">
        Îã§Ïãú ÏãúÎèÑ
      </button>
    `;
  }

  // Í∏ÄÏûêÏàò Ïπ¥Ïö¥Ìä∏ Î∞è ÌîÑÎ°úÍ∑∏Î†àÏä§ Î∞î ÏóÖÎç∞Ïù¥Ìä∏
  function updateCharCount(textareaId, countId, maxLength) {
    const textarea = document.getElementById(textareaId);
    const countElement = document.getElementById(countId);
    const progressElement = document.getElementById(textareaId.replace('Content', 'Progress'));

    if (!textarea || !countElement || !progressElement) return;

    const currentLength = textarea.value.length;
    const percentage = (currentLength / maxLength) * 100;

    countElement.textContent = currentLength;
    progressElement.style.width = Math.min(percentage, 100) + '%';

    // Í∏ÄÏûêÏàòÍ∞Ä Ï¥àÍ≥ºÎêòÎ©¥ ÏÉâÏÉÅ Î≥ÄÍ≤Ω
    if (currentLength > maxLength) {
      countElement.style.color = '#ef4444';
      progressElement.style.background = '#ef4444';
    } else {
      countElement.style.color = '#6b7280';
      progressElement.style.background = '#3b82f6';
    }
  }

  // Ï†ÄÏû• Í∏∞Îä•
  async function saveContent(isAutoSave = false) {
    if (!resumeId || currentSections.length === 0) {
      if (!isAutoSave) {
        alert('Ï†ÄÏû•Ìï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
      }
      return;
    }

    const saveBtn = document.getElementById('headerSaveBtn');
    const originalText = saveBtn.textContent;

    if (!isAutoSave) {
      saveBtn.disabled = true;
      saveBtn.textContent = 'Ï†ÄÏû• Ï§ë...';
    }

    try {
      for (const section of currentSections) {
        const sectionType = section.section_type || section.sectionType;
        const sectionId = sectionType.toLowerCase();
        const textarea = document.getElementById(`${sectionId}Content`);

        if (textarea) {
          await fetch(`/api/resumes/${resumeId}/sections`, {
            method: 'POST',
            headers: getCSRFHeaders(),
            body: JSON.stringify({
              sectionType: sectionType,
              content: textarea.value.trim()
            })
          });
        }
      }

      if (isAutoSave) {
        // ÏûêÎèô Ï†ÄÏû• ÌëúÏãú
        showAutoSaveIndicator();
      } else {
        // ÏàòÎèô Ï†ÄÏû• ÏôÑÎ£å ÏïåÎ¶º
        saveBtn.textContent = '‚úÖ Ï†ÄÏû•ÏôÑÎ£å';
        saveBtn.style.background = '#059669';

        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.style.background = '#059669';
          saveBtn.disabled = false;
        }, 2000);
      }

    } catch (error) {
      console.error('Save error:', error);
      if (!isAutoSave) {
        alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
      }
    }
  }

  // ÏûêÎèô Ï†ÄÏû• ÏãúÏûë
  function startAutoSave() {
    // Í∏∞Ï°¥ Ïù∏ÌÑ∞Î≤åÏù¥ ÏûàÎã§Î©¥ Ï†ïÎ¶¨
    if (autoSaveInterval) {
      clearInterval(autoSaveInterval);
    }

    // 5Î∂Ñ(300,000ms)ÎßàÎã§ ÏûêÎèô Ï†ÄÏû•
    autoSaveInterval = setInterval(() => {
      saveContent(true);
    }, 300000);
  }

  // ÏûêÎèô Ï†ÄÏû• ÌëúÏãú
  function showAutoSaveIndicator() {
    const indicator = document.getElementById('autoSaveIndicator');
    indicator.classList.add('show');

    setTimeout(() => {
      indicator.classList.remove('show');
    }, 3000);
  }

  // ÌååÏùº Ï†ÄÏû• Î™®Îã¨ ÌëúÏãú
  function showExportModal() {
    const modal = document.getElementById('exportModal');
    modal.classList.add('show');

    // ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
    selectedExportType = null;
    document.getElementById('exportConfirmBtn').disabled = true;
    document.querySelectorAll('.export-option').forEach(option => {
      option.classList.remove('selected');
    });
    document.querySelectorAll('input[name="exportType"]').forEach(radio => {
      radio.checked = false;
    });
  }

  // ÌååÏùº Ï†ÄÏû• Î™®Îã¨ Îã´Í∏∞
  function closeExportModal(event) {
    if (event && event.target !== event.currentTarget) return;

    const modal = document.getElementById('exportModal');
    modal.classList.remove('show');
  }

  // ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÌòïÏãù ÏÑ†ÌÉù
  function selectExportOption(type) {
    selectedExportType = type;

    // Î™®Îì† ÏòµÏÖò ÏÑ†ÌÉù Ìï¥Ï†ú
    document.querySelectorAll('.export-option').forEach(option => {
      option.classList.remove('selected');
    });

    // ÏÑ†ÌÉùÎêú ÏòµÏÖò ÌôúÏÑ±Ìôî
    const selectedOption = document.querySelector(`input[value="${type}"]`).closest('.export-option');
    selectedOption.classList.add('selected');

    // ÎùºÎîîÏò§ Î≤ÑÌäº Ï≤¥ÌÅ¨
    document.querySelector(`input[value="${type}"]`).checked = true;

    // ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Î≤ÑÌäº ÌôúÏÑ±Ìôî
    document.getElementById('exportConfirmBtn').disabled = false;
  }

  // ÌååÏùº ÎÇ¥Î≥¥ÎÇ¥Í∏∞
  async function exportFile() {
    if (!selectedExportType || !resumeId) {
      alert('ÎÇ¥Î≥¥ÎÇº ÌòïÏãùÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
      return;
    }

    const exportBtn = document.getElementById('exportConfirmBtn');
    const originalText = exportBtn.textContent;
    exportBtn.disabled = true;
    exportBtn.textContent = 'ÎÇ¥Î≥¥ÎÇ¥Îäî Ï§ë...';

    try {
      // Î®ºÏ†Ä ÌòÑÏû¨ ÎÇ¥Ïö© Ï†ÄÏû•
      await saveContent(true);

      // ÌååÏùº ÎÇ¥Î≥¥ÎÇ¥Í∏∞ API Ìò∏Ï∂ú
      const response = await fetch(`/api/resumes/${resumeId}/export`, {
        method: 'POST',
        headers: getCSRFHeaders(),
        body: JSON.stringify({
          format: selectedExportType
        })
      });

      if (response.ok) {
        // ÌååÏùº Îã§Ïö¥Î°úÎìú
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;

        // ÌååÏùºÎ™Ö ÏÑ§Ï†ï
        const resumeTitle = document.getElementById('resumeTitle').textContent || 'ÏûêÍ∏∞ÏÜåÍ∞úÏÑú';
        const extension = selectedExportType === 'docx' ? 'docx' : selectedExportType;
        a.download = `${resumeTitle}.${extension}`;

        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        // Î™®Îã¨ Îã´Í∏∞
        closeExportModal();

        // ÏÑ±Í≥µ Î©îÏãúÏßÄ
        exportBtn.textContent = '‚úÖ ÏôÑÎ£å';
        setTimeout(() => {
          exportBtn.textContent = originalText;
          exportBtn.disabled = false;
        }, 2000);

      } else {
        const errorText = await response.text();
        throw new Error(`ÌååÏùº ÎÇ¥Î≥¥ÎÇ¥Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ${errorText}`);
      }

    } catch (error) {
      console.error('Export error:', error);
      alert('ÌååÏùº ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
      exportBtn.textContent = originalText;
      exportBtn.disabled = false;
    }
  }

  // ÌéòÏù¥ÏßÄ Î°úÎìúÏãú Ïã§Ìñâ
  document.addEventListener('DOMContentLoaded', loadResumeData);

  // ÌéòÏù¥ÏßÄ Îñ†ÎÇ† Îïå ÏûêÎèô Ï†ÄÏû• Ï†ïÎ¶¨
  window.addEventListener('beforeunload', () => {
    if (autoSaveInterval) {
      clearInterval(autoSaveInterval);
    }
  });
</script>
</body>
</html>