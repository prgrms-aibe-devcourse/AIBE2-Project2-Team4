<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title id="pageTitle">ì´ë ¥ì„œ ì‘ì„±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f9fafb;
      line-height: 1.6;
    }

    .header {
      background: white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 2rem 0;
    }

    .header-content {
      max-width: 64rem;
      margin: 0 auto;
      padding: 0 1rem;
      text-align: center;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }

    .header p {
      color: #6b7280;
    }

    .container {
      max-width: 96rem;
      margin: 0 auto;
      padding: 2rem 1rem 2rem 4rem;
      display: flex;
      gap: 2rem;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3rem;
    }

    .section {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #2563eb;
      margin-bottom: 1.5rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    select {
      padding-right: 2.5rem;
      background: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>') no-repeat right 0.75rem center;
      background-size: 1rem;
      appearance: none;
    }

    textarea {
      resize: none;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .education-subsection {
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .education-subsection h3 {
      font-weight: 500;
      color: #1f2937;
      margin-bottom: 1rem;
    }

    .dynamic-item {
      background: #f9fafb;
      padding: 1.5rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      position: relative;
    }

    .form-content {
      margin-top: 1.5rem;
    }

    .remove-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      color: #ef4444;
      border: none;
      width: 2.5rem;
      height: 2.5rem;
      cursor: pointer;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.25rem;
      transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out;
    }

    .remove-btn:hover {
      color: #dc2626;
      background: rgba(239, 68, 68, 0.1);
    }

    .add-btn {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #93c5fd;
      background: transparent;
      color: #2563eb;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background-color 0.15s ease-in-out;
    }

    .add-btn:hover {
      background: #dbeafe;
    }

    .sidebar {
      width: 16rem;
    }

    .sidebar-fixed {
      position: sticky;
      top: 1rem;
      width: 16rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-self: flex-start;
    }

    .menu-card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 1rem;
    }

    .menu-title {
      font-size: 0.875rem;
      font-weight: 700;
      color: #2563eb;
      margin-bottom: 1rem;
      text-align: center;
    }

    .menu-nav {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .menu-item {
      width: 100%;
      text-align: left;
      padding: 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 500;
      background: transparent;
      border: none;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.15s ease-in-out;
    }

    .menu-item:hover {
      color: #1f2937;
      background: #f9fafb;
    }

    .submit-btn {
      width: 100%;
      background: #2563eb;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.15s ease-in-out;
    }

    .submit-btn:hover {
      background: #1d4ed8;
    }

    .submit-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #374151;
      cursor: pointer;
    }

    .checkbox-label input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 4rem;
      color: #6b7280;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #e5e7eb;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 1s ease-in-out infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
        padding: 1rem 1rem 1rem 2rem;
      }

      .sidebar {
        width: 100%;
        order: -1;
      }

      .sidebar-fixed {
        position: static;
        width: 100%;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="header">
  <div class="header-content">
    <h1 id="headerTitle">ì´ë ¥ì„œ ì‘ì„±</h1>
    <p id="headerDescription">ë‚˜ë§Œì˜ íŠ¹ë³„í•œ ì´ë ¥ì„œë¡œ ì›í•˜ëŠ” ì·¨ì—…ì— ë„ì „í•˜ì„¸ìš”.</p>
  </div>
</div>

<!-- ë¡œë”© ìƒíƒœ -->
<div id="loadingState" class="loading">
  <div class="spinner"></div>
  <p>ì´ë ¥ì„œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>

<div class="container" id="mainContainer" style="display: none;">
  <div class="main-content">
    <!-- ì œëª© ì„¹ì…˜ -->
    <section id="basic" class="section">
      <h2 class="section-title">ì œëª©</h2>
      <input
              type="text"
              id="title"
              placeholder="ì´ë ¥ì„œ 01"
      >
    </section>

    <!-- ì§ë¬´ ë° ì—…ì¢… -->
    <section id="job" class="section">
      <h2 class="section-title">ì§ë¬´ ë° ì—…ì¢…</h2>
      <div class="form-group">
        <label for="industry">ì—…ì¢…</label>
        <select id="industry">
          <option value="">ê´€ì‹¬ìˆëŠ” ê¸°ì—…ì˜ ì—…ì¢…ì„ ì•Œê³  ìˆë‚˜ìš”? ğŸ˜Š</option>
          <option value="IT/ì†Œí”„íŠ¸ì›¨ì–´">IT/ì†Œí”„íŠ¸ì›¨ì–´</option>
          <option value="ì œì¡°ì—…">ì œì¡°ì—…</option>
          <option value="ê¸ˆìœµ">ê¸ˆìœµ</option>
          <option value="êµìœ¡">êµìœ¡</option>
          <option value="ì˜ë£Œ/ë°”ì´ì˜¤">ì˜ë£Œ/ë°”ì´ì˜¤</option>
          <option value="ê±´ì„¤/ë¶€ë™ì‚°">ê±´ì„¤/ë¶€ë™ì‚°</option>
          <option value="ìœ í†µ/ë¬¼ë¥˜">ìœ í†µ/ë¬¼ë¥˜</option>
          <option value="ë¯¸ë””ì–´/ê´‘ê³ ">ë¯¸ë””ì–´/ê´‘ê³ </option>
          <option value="ì„œë¹„ìŠ¤ì—…">ì„œë¹„ìŠ¤ì—…</option>
          <option value="ê¸°íƒ€">ê¸°íƒ€</option>
        </select>
      </div>
      <div class="form-group">
        <label for="position">ì§ë¬´</label>
        <select id="position" disabled>
          <option value="">ë¨¼ì € ì—…ì¢…ì„ ì„ íƒí•´ ì£¼ì„¸ìš”</option>
        </select>
      </div>
      <div class="form-group">
        <label for="target-company">ëª©í‘œ íšŒì‚¬</label>
        <input
                type="text"
                id="target-company"
                placeholder="ëª©í‘œ íšŒì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
        >
      </div>
    </section>

    <!-- í•™ë ¥ ì„¹ì…˜ -->
    <section id="education" class="section">
      <h2 class="section-title">í•™ë ¥</h2>

      <!-- ê³ ë“±í•™êµ -->
      <div class="education-subsection">
        <h3>ê³ ë“±í•™êµ</h3>
        <div class="form-row">
          <div class="form-group">
            <label>í•™êµëª…</label>
            <input type="text" id="highschool-name" placeholder="ê³ ë“±í•™êµëª…">
          </div>
          <div class="form-group">
            <label>ì¡¸ì—…ë…„ë„</label>
            <select id="highschool-year">
              <option value="">ì¡¸ì—…ë…„ë„ ì„ íƒ</option>
            </select>
          </div>
        </div>
      </div>

      <!-- ëŒ€í•™êµ -->
      <div class="education-subsection">
        <h3>ëŒ€í•™êµ</h3>
        <div id="universities"></div>
        <button type="button" class="add-btn" onclick="addUniversity()">+ ëŒ€í•™êµ ì¶”ê°€</button>
      </div>

      <!-- ëŒ€í•™ì› -->
      <div class="education-subsection">
        <h3>ëŒ€í•™ì›</h3>
        <div id="graduate-schools"></div>
        <button type="button" class="add-btn" onclick="addGraduateSchool()">+ ëŒ€í•™ì› ì¶”ê°€</button>
      </div>
    </section>

    <!-- ê²½ë ¥ ì„¹ì…˜ -->
    <section id="career" class="section">
      <h2 class="section-title">ê²½ë ¥</h2>
      <div id="careers"></div>
      <button type="button" class="add-btn" onclick="addCareer()">+ ê²½ë ¥ ì¶”ê°€</button>
    </section>

    <!-- í™œë™ ì„¹ì…˜ -->
    <section id="experience" class="section">
      <h2 class="section-title">í™œë™</h2>
      <div id="experiences"></div>
      <button type="button" class="add-btn" onclick="addExperience()">+ í™œë™ ì¶”ê°€</button>
    </section>

    <!-- ê°•ì¡° í¬ì¸íŠ¸ ì„¹ì…˜ -->
    <section id="highlights" class="section" style="margin-bottom: 5rem;">
      <h2 class="section-title">ê°•ì¡° í¬ì¸íŠ¸</h2>
      <div class="form-group">
        <label for="highlights-text">ê°•ì¡°í•˜ê³  ì‹¶ì€ ë‚´ìš©</label>
        <textarea
                id="highlights-text"
                rows="6"
                placeholder="ìì‹ ì˜ ê°•ì , íŠ¹ë³„í•œ ê²½í—˜, ì„±ê³¼ ë“±ì„ ììœ ë¡­ê²Œ ì…ë ¥í•˜ì„¸ìš”"
        ></textarea>
      </div>
    </section>
  </div>

  <!-- ì‚¬ì´ë“œë°” -->
  <div class="sidebar">
    <div class="sidebar-fixed">
      <div class="menu-card">
        <h3 class="menu-title">ëª©ì°¨</h3>
        <nav class="menu-nav">
          <button class="menu-item" onclick="scrollToSection('basic')">ì œëª©</button>
          <button class="menu-item" onclick="scrollToSection('job')">ì—…ì¢… ë° ì§ë¬´</button>
          <button class="menu-item" onclick="scrollToSection('education')">í•™ë ¥</button>
          <button class="menu-item" onclick="scrollToSection('career')">ê²½ë ¥</button>
          <button class="menu-item" onclick="scrollToSection('experience')">í™œë™</button>
          <button class="menu-item" onclick="scrollToSection('highlights')">ê°•ì¡° í¬ì¸íŠ¸</button>
        </nav>
      </div>

      <button class="submit-btn" onclick="handleSubmit()" id="submitBtn">AI ì´ë ¥ì„œ ìƒì„±</button>
    </div>
  </div>
</div>

<script>
  // ì „ì—­ ë³€ìˆ˜
  let isEditMode = false;
  let currentResumeId = null;
  let formData = {
    title: '',
    industry: '',
    position: '',
    targetCompany: '',
    highlights: '',
    highschool: { schoolName: '', graduationYear: '' },
    universities: [],
    graduateSchools: [],
    careers: [],
    experiences: []
  };

  let resumeCounter = 1;

  // ì—…ì¢…ë³„ ì§ë¬´ ë§¤í•‘
  const industryToPositionMapping = {
    'IT/ì†Œí”„íŠ¸ì›¨ì–´': ['ì›¹ê°œë°œ', 'ì•±ê°œë°œ', 'í”„ë¡ íŠ¸ì—”ë“œ', 'ë°±ì—”ë“œ', 'í’€ìŠ¤íƒ', 'ë°ì´í„°ë¶„ì„', 'AI/ML', 'ë³´ì•ˆ', 'ë„¤íŠ¸ì›Œí¬', 'ì‹œìŠ¤í…œê´€ë¦¬', 'QA', 'UI/UX', 'ì›¹ë””ìì¸'],
    'ì œì¡°ì—…': ['ìƒì‚°ê´€ë¦¬', 'í’ˆì§ˆê´€ë¦¬', 'ê³µì •ê´€ë¦¬', 'ì œì¡°ê¸°ìˆ ', 'ì„¤ë¹„ê´€ë¦¬', 'ì—°êµ¬ê°œë°œ', 'ì œí’ˆê°œë°œ'],
    'ê¸ˆìœµ': ['ê²½ì˜ê¸°íš', 'ì‚¬ì—…ê¸°íš', 'ì¬ë¬´', 'íšŒê³„', 'ë²•ë¬´', 'ë¦¬ìŠ¤í¬ê´€ë¦¬', 'íˆ¬ìë¶„ì„', 'ë³´í—˜ì‹¬ì‚¬'],
    'êµìœ¡': ['ì´ˆë“±êµì‚¬', 'ì¤‘ë“±êµì‚¬', 'ê³ ë“±êµì‚¬', 'ê°•ì‚¬', 'êµìœ¡ê¸°íš', 'êµìœ¡ì»¨ì„¤íŒ…'],
    'ì˜ë£Œ/ë°”ì´ì˜¤': ['ì˜ì‚¬', 'ê°„í˜¸ì‚¬', 'ì•½ì‚¬', 'ë¬¼ë¦¬ì¹˜ë£Œì‚¬', 'ì˜ë£Œê¸°ê¸°', 'ì—°êµ¬ê°œë°œ', 'ê¸°ìˆ ì—°êµ¬'],
    'ê±´ì„¤/ë¶€ë™ì‚°': ['ê±´ì¶•ì„¤ê³„', 'í† ëª©ì„¤ê³„', 'ì‹œê³µê´€ë¦¬', 'ì•ˆì „ê´€ë¦¬', 'ë¶€ë™ì‚°ê°œë°œ', 'ë¶€ë™ì‚°ì»¨ì„¤íŒ…'],
    'ìœ í†µ/ë¬¼ë¥˜': ['ë¬´ì—­ì‚¬ë¬´', 'í•´ì™¸ì˜ì—…', 'êµ¬ë§¤', 'ë¬¼ë¥˜', 'ìœ í†µ', 'MD', 'ìƒí’ˆê¸°íš'],
    'ë¯¸ë””ì–´/ê´‘ê³ ': ['ë§ˆì¼€íŒ…ê¸°íš', 'ë¸Œëœë“œë§ˆì¼€íŒ…', 'ë””ì§€í„¸ë§ˆì¼€íŒ…', 'ê´‘ê³ ê¸°íš', 'í™ë³´', 'PR', 'ê·¸ë˜í”½ë””ìì¸', 'ì½˜í…ì¸ ê¸°íš'],
    'ì„œë¹„ìŠ¤ì—…': ['ê¸°ì—…ì˜ì—…', 'ê°œì¸ì˜ì—…', 'ë‚´ê·¼ì˜ì—…', 'ê³ ê°ìƒë‹´', 'í…”ë ˆë§ˆì¼€íŒ…', 'ì„œë¹„ìŠ¤ê¸°íš'],
    'ê¸°íƒ€': ['ê²½ì˜ê¸°íš', 'ì‚¬ì—…ê¸°íš', 'ì´ë¬´', 'ì¸ì‚¬', 'ë§ˆì¼€íŒ…ê¸°íš', 'ì˜ì—…', 'ê¸°íƒ€']
  };

  // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
  function getCSRFHeaders() {
    const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

    const headers = {
      'Content-Type': 'application/json',
    };

    if (token && header) {
      headers[header] = token;
    }

    return headers;
  }

  // URLì—ì„œ resumeId íŒŒë¼ë¯¸í„° ì¶”ì¶œ
  function getResumeIdFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('resumeId');
  }

  // í˜ì´ì§€ ì´ˆê¸°í™”
  async function init() {
    setupYearOptions();

    // URLì—ì„œ resumeId í™•ì¸
    const resumeId = getResumeIdFromUrl();

    if (resumeId) {
      // í¸ì§‘ ëª¨ë“œ
      isEditMode = true;
      currentResumeId = resumeId;

      // UI ë³€ê²½
      document.getElementById('pageTitle').textContent = 'ì´ë ¥ì„œ ìˆ˜ì •';
      document.getElementById('headerTitle').textContent = 'ì´ë ¥ì„œ ìˆ˜ì •';
      document.getElementById('headerDescription').textContent = 'ê¸°ì¡´ ì´ë ¥ì„œ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.';
      document.getElementById('submitBtn').textContent = 'AI ì´ë ¥ì„œ ìˆ˜ì •';

      // ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
      await loadExistingData(resumeId);
    } else {
      // ìƒˆ ì‘ì„± ëª¨ë“œ
      isEditMode = false;
      setDefaultTitle();
      hideLoading();
    }

    setupEventListeners();
  }

  // ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
  async function loadExistingData(resumeId) {
    try {
      showLoading();

      const response = await fetch(`/api/resumes/${resumeId}`, {
        method: 'GET',
        headers: getCSRFHeaders()
      });

      if (response.ok) {
        const resumeData = await response.json();
        populateFormWithData(resumeData);
        hideLoading();
      } else {
        throw new Error('ì´ë ¥ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    } catch (error) {
      console.error('Load error:', error);
      alert('ì´ë ¥ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      // ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
      window.location.href = '/resumes';
    }
  }

  // í¼ì— ê¸°ì¡´ ë°ì´í„° ì±„ìš°ê¸°
  function populateFormWithData(resumeData) {
    // ê¸°ë³¸ ì •ë³´
    document.getElementById('title').value = resumeData.title || '';
    document.getElementById('target-company').value = resumeData.targetCompany || '';
    document.getElementById('highlights-text').value = resumeData.highlights || '';

    // ì—…ì¢…/ì§ë¬´
    if (resumeData.industry) {
      document.getElementById('industry').value = resumeData.industry;
      updatePositionOptions();
      if (resumeData.position) {
        document.getElementById('position').value = resumeData.position;
      }
    }

    // formData ì—…ë°ì´íŠ¸
    formData.title = resumeData.title || '';
    formData.industry = resumeData.industry || '';
    formData.position = resumeData.position || '';
    formData.targetCompany = resumeData.targetCompany || '';
    formData.highlights = resumeData.highlights || '';

    // í•™ë ¥ ì •ë³´ (ê³ ë“±í•™êµ)
    if (resumeData.educations) {
      const highSchool = resumeData.educations.find(edu => edu.type === 'HIGH_SCHOOL');
      if (highSchool) {
        document.getElementById('highschool-name').value = highSchool.schoolName || '';
        if (highSchool.graduationDate) {
          const gradYear = new Date(highSchool.graduationDate).getFullYear();
          document.getElementById('highschool-year').value = gradYear;
        }
        formData.highschool.schoolName = highSchool.schoolName || '';
        formData.highschool.graduationYear = document.getElementById('highschool-year').value;
      }

      // ëŒ€í•™êµ
      const universities = resumeData.educations.filter(edu => edu.type === 'UNIVERSITY');
      universities.forEach(university => {
        addUniversity();
        const index = formData.universities.length - 1;
        formData.universities[index] = {
          schoolName: university.schoolName || '',
          type: university.level || '',
          major: university.major || '',
          additionalMajor: university.additionalMajor || '',
          admissionDate: university.admissionDate || '',
          graduationDate: university.graduationDate || '',
          isCurrent: university.isCurrent || false
        };
        updateUniversityDisplay(index);
      });

      // ëŒ€í•™ì›
      const graduateSchools = resumeData.educations.filter(edu => edu.type === 'GRADUATE_SCHOOL');
      graduateSchools.forEach(graduate => {
        addGraduateSchool();
        const index = formData.graduateSchools.length - 1;
        formData.graduateSchools[index] = {
          schoolName: graduate.schoolName || '',
          type: graduate.level || '',
          major: graduate.major || '',
          admissionDate: graduate.admissionDate || '',
          graduationDate: graduate.graduationDate || '',
          isCurrent: graduate.isCurrent || false
        };
        updateGraduateSchoolDisplay(index);
      });
    }

    // ê²½ë ¥ ì •ë³´
    if (resumeData.careers) {
      resumeData.careers.forEach(career => {
        addCareer();
        const index = formData.careers.length - 1;
        formData.careers[index] = {
          companyName: career.companyName || '',
          department: career.department || '',
          positionTitle: career.positionTitle || '',
          startDate: career.startDate || '',
          endDate: career.endDate || '',
          isCurrent: career.isCurrent || false,
          responsibilities: career.responsibilities || '',
          resignationReason: career.resignationReason || ''
        };
        updateCareerDisplay(index);
      });
    }

    // í™œë™/ê²½í—˜
    if (resumeData.experiences) {
      resumeData.experiences.forEach(experience => {
        addExperience();
        const index = formData.experiences.length - 1;
        formData.experiences[index] = {
          activityName: experience.activityName || '',
          institution: experience.institution || '',
          startDate: experience.startDate || '',
          endDate: experience.endDate || '',
          isCurrent: experience.isCurrent || false,
          content: experience.content || ''
        };
        updateExperienceDisplay(index);
      });
    }
  }

  // í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤
  function updateUniversityDisplay(index) {
    const container = document.getElementById('universities');
    const universityDiv = container.children[index];
    const data = formData.universities[index];

    universityDiv.querySelector('input[placeholder="ëŒ€í•™êµëª…"]').value = data.schoolName;
    universityDiv.querySelector('select').value = data.type;
    const inputs = universityDiv.querySelectorAll('input');
    inputs[1].value = data.admissionDate; // ì…í•™ì¼
    inputs[2].value = data.graduationDate; // ì¡¸ì—…ì¼
    inputs[3].value = data.major; // ì „ê³µ
    inputs[4].value = data.additionalMajor; // ì¶”ê°€ì „ê³µ
    universityDiv.querySelector('input[type="checkbox"]').checked = data.isCurrent;
  }

  function updateGraduateSchoolDisplay(index) {
    const container = document.getElementById('graduate-schools');
    const graduateDiv = container.children[index];
    const data = formData.graduateSchools[index];

    graduateDiv.querySelector('input[placeholder="ëŒ€í•™ì›ëª…"]').value = data.schoolName;
    graduateDiv.querySelector('select').value = data.type;
    const inputs = graduateDiv.querySelectorAll('input');
    inputs[1].value = data.admissionDate; // ì…í•™ì¼
    inputs[2].value = data.graduationDate; // ì¡¸ì—…ì¼
    inputs[3].value = data.major; // ì „ê³µ
    graduateDiv.querySelector('input[type="checkbox"]').checked = data.isCurrent;
  }

  function updateCareerDisplay(index) {
    const container = document.getElementById('careers');
    const careerDiv = container.children[index];
    const data = formData.careers[index];

    const inputs = careerDiv.querySelectorAll('input');
    const textareas = careerDiv.querySelectorAll('textarea');

    inputs[0].value = data.companyName; // íšŒì‚¬ëª…
    inputs[1].value = data.department; // ë¶€ì„œ
    inputs[2].value = data.startDate; // ì…ì‚¬ì¼
    inputs[3].value = data.endDate; // í‡´ì‚¬ì¼
    inputs[4].value = data.positionTitle; // ì§ê¸‰
    careerDiv.querySelector('input[type="checkbox"]').checked = data.isCurrent;
    textareas[0].value = data.responsibilities; // ë‹´ë‹¹ì—…ë¬´
    inputs[5].value = data.resignationReason; // í‡´ì‚¬ì‚¬ìœ 
  }

  function updateExperienceDisplay(index) {
    const container = document.getElementById('experiences');
    const experienceDiv = container.children[index];
    const data = formData.experiences[index];

    const inputs = experienceDiv.querySelectorAll('input');
    const textarea = experienceDiv.querySelector('textarea');

    inputs[0].value = data.activityName; // í™œë™ëª…
    inputs[1].value = data.institution; // ê¸°ê´€/ì¥ì†Œ
    inputs[2].value = data.startDate; // ì‹œì‘ì¼
    inputs[3].value = data.endDate; // ì¢…ë£Œì¼
    experienceDiv.querySelector('input[type="checkbox"]').checked = data.isCurrent;
    textarea.value = data.content; // ë‚´ìš©
  }

  // ë¡œë”© ìƒíƒœ í‘œì‹œ/ìˆ¨ê¹€
  function showLoading() {
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('mainContainer').style.display = 'none';
  }

  function hideLoading() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('mainContainer').style.display = 'flex';
  }

  // ê¸°ë³¸ ì œëª© ì„¤ì •
  function setDefaultTitle() {
    const titleInput = document.getElementById('title');
    const defaultTitle = `ì´ë ¥ì„œ ${String(resumeCounter).padStart(2, '0')}`;
    titleInput.placeholder = defaultTitle;
    titleInput.value = '';
    formData.title = '';
    updateSubmitButton();
  }

  // ë…„ë„ ì˜µì…˜ ì„¤ì •
  function setupYearOptions() {
    const currentYear = new Date().getFullYear();
    const yearSelect = document.getElementById('highschool-year');

    for (let i = 0; i < 50; i++) {
      const year = currentYear - i;
      const option = document.createElement('option');
      option.value = year;
      option.textContent = year + 'ë…„';
      yearSelect.appendChild(option);
    }
  }

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
  function setupEventListeners() {
    // ì—…ì¢… ë³€ê²½ ì‹œ ì§ë¬´ ì—…ë°ì´íŠ¸
    document.getElementById('industry').addEventListener('change', function() {
      updatePositionOptions();
      formData.industry = this.value;
      formData.position = ''; // ì§ë¬´ ì´ˆê¸°í™”
      updateSubmitButton();
    });

    // ì œëª© ì…ë ¥ ê°ì§€
    document.getElementById('title').addEventListener('input', function() {
      formData.title = this.value;
      updateSubmitButton();
    });

    // ì§ë¬´ ì„ íƒ
    document.getElementById('position').addEventListener('change', function() {
      formData.position = this.value;
      updateSubmitButton();
    });

    // ëª©í‘œ íšŒì‚¬ ì…ë ¥
    document.getElementById('target-company').addEventListener('input', function() {
      formData.targetCompany = this.value;
    });

    // ê°•ì¡° í¬ì¸íŠ¸
    document.getElementById('highlights-text').addEventListener('input', function() {
      formData.highlights = this.value;
    });

    // ê³ ë“±í•™êµ ì •ë³´
    document.getElementById('highschool-name').addEventListener('input', function() {
      formData.highschool.schoolName = this.value;
    });

    document.getElementById('highschool-year').addEventListener('change', function() {
      formData.highschool.graduationYear = this.value;
    });
  }

  // ì§ë¬´ ì˜µì…˜ ì—…ë°ì´íŠ¸
  function updatePositionOptions() {
    const industry = document.getElementById('industry').value;
    const positionSelect = document.getElementById('position');

    // ê¸°ì¡´ ì˜µì…˜ ì œê±°
    positionSelect.innerHTML = '';

    if (!industry) {
      positionSelect.disabled = true;
      positionSelect.innerHTML = '<option value="">ë¨¼ì € ì—…ì¢…ì„ ì„ íƒí•´ ì£¼ì„¸ìš”</option>';
      return;
    }

    positionSelect.disabled = false;
    positionSelect.innerHTML = '<option value="">ì§ë¬´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”</option>';

    const positions = industryToPositionMapping[industry] || [];
    positions.forEach(position => {
      const option = document.createElement('option');
      option.value = position;
      option.textContent = position;
      positionSelect.appendChild(option);
    });
  }

  // ì œì¶œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  function updateSubmitButton() {
    const submitBtn = document.querySelector('.submit-btn');
    submitBtn.disabled = false;
  }

  // ìŠ¤í¬ë¡¤ ê¸°ëŠ¥
  function scrollToSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
      section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  // ëŒ€í•™êµ ì¶”ê°€
  function addUniversity() {
    const container = document.getElementById('universities');
    const index = formData.universities.length;

    const universityDiv = document.createElement('div');
    universityDiv.className = 'dynamic-item';
    universityDiv.innerHTML = `
      <button type="button" class="remove-btn" onclick="removeUniversity(${index})">Ã—</button>
      <div class="form-content">
        <div class="form-row">
          <div class="form-group">
            <label>í•™êµëª…</label>
            <input type="text" placeholder="ëŒ€í•™êµëª…" onchange="updateUniversity(${index}, 'schoolName', this.value)">
          </div>
          <div class="form-group">
            <label>ë¶„ë¥˜</label>
            <select onchange="updateUniversity(${index}, 'type', this.value)">
              <option value="">ì„ íƒ</option>
              <option value="2ë…„ì œ">2ë…„ì œ</option>
              <option value="3ë…„ì œ">3ë…„ì œ</option>
              <option value="4ë…„ì œ">4ë…„ì œ</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>ì…í•™</label>
            <input type="month" data-field="admission" onchange="updateUniversity(${index}, 'admissionDate', this.value)">
          </div>
          <div class="form-group">
            <label>ì¡¸ì—…</label>
            <input type="month" data-field="graduation" onchange="updateUniversity(${index}, 'graduationDate', this.value)">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>ì „ê³µ</label>
            <input type="text" placeholder="ì „ê³µ" onchange="updateUniversity(${index}, 'major', this.value)">
          </div>
          <div class="form-group">
            <label>ì¶”ê°€ì „ê³µ</label>
            <input type="text" placeholder="ë¶€ì „ê³µ, ë³µìˆ˜ì „ê³µ ë“±" onchange="updateUniversity(${index}, 'additionalMajor', this.value)">
          </div>
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" onchange="updateUniversity(${index}, 'isCurrent', this.checked)">
            <span>ì¬í•™ì¤‘</span>
          </label>
        </div>
      </div>
    `;

    container.appendChild(universityDiv);
    formData.universities.push({
      schoolName: '', type: '', major: '', additionalMajor: '',
      admissionDate: '', graduationDate: '', isCurrent: false
    });
  }

  // ëŒ€í•™êµ ì •ë³´ ì—…ë°ì´íŠ¸
  function updateUniversity(index, field, value) {
    if (formData.universities[index]) {
      formData.universities[index][field] = value;

      // ì¬í•™ì¤‘ ì²´í¬ë°•ìŠ¤ê°€ ë³€ê²½ë˜ë©´ ì¡¸ì—…ì¼ í•„ë“œ ë¹„í™œì„±í™”/í™œì„±í™”
      if (field === 'isCurrent') {
        const container = document.getElementById('universities');
        const universityDiv = container.children[index];
        const graduationInput = universityDiv.querySelector('input[data-field="graduation"]');
        if (graduationInput) {
          graduationInput.disabled = value;
          if (value) {
            graduationInput.value = '';
            formData.universities[index].graduationDate = '';
          }
        }
      }
    }
  }

  // ëŒ€í•™êµ ì œê±°
  function removeUniversity(index) {
    const container = document.getElementById('universities');
    container.children[index].remove();
    formData.universities.splice(index, 1);
    regenerateUniversities();
  }

  // ëŒ€í•™êµ ëª©ë¡ ì¬ìƒì„±
  function regenerateUniversities() {
    const container = document.getElementById('universities');
    const universities = [...formData.universities];
    container.innerHTML = '';
    formData.universities = [];
    universities.forEach(() => addUniversity());
  }

  // ëŒ€í•™ì› ì¶”ê°€
  function addGraduateSchool() {
    const container = document.getElementById('graduate-schools');
    const index = formData.graduateSchools.length;

    const graduateDiv = document.createElement('div');
    graduateDiv.className = 'dynamic-item';
    graduateDiv.innerHTML = `
      <button type="button" class="remove-btn" onclick="removeGraduateSchool(${index})">Ã—</button>
      <div class="form-content">
        <div class="form-row">
          <div class="form-group">
            <label>í•™êµëª…</label>
            <input type="text" placeholder="ëŒ€í•™ì›ëª…" onchange="updateGraduateSchool(${index}, 'schoolName', this.value)">
          </div>
          <div class="form-group">
            <label>ê³¼ì •</label>
            <select onchange="updateGraduateSchool(${index}, 'type', this.value)">
              <option value="">ì„ íƒ</option>
              <option value="ì„ì‚¬">ì„ì‚¬</option>
              <option value="ë°•ì‚¬">ë°•ì‚¬</option>
              <option value="ì„ë°•í†µí•©">ì„ë°•í†µí•©</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>ì…í•™</label>
            <input type="month" data-field="admission" onchange="updateGraduateSchool(${index}, 'admissionDate', this.value)">
          </div>
          <div class="form-group">
            <label>ì¡¸ì—…</label>
            <input type="month" data-field="graduation" onchange="updateGraduateSchool(${index}, 'graduationDate', this.value)">
          </div>
        </div>
        <div class="form-group">
          <label>ì „ê³µ</label>
          <input type="text" placeholder="ì „ê³µ" onchange="updateGraduateSchool(${index}, 'major', this.value)">
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" onchange="updateGraduateSchool(${index}, 'isCurrent', this.checked)">
            <span>ì¬í•™ì¤‘</span>
          </label>
        </div>
      </div>
    `;

    container.appendChild(graduateDiv);
    formData.graduateSchools.push({
      schoolName: '', type: '', major: '',
      admissionDate: '', graduationDate: '', isCurrent: false
    });
  }

  // ëŒ€í•™ì› ì •ë³´ ì—…ë°ì´íŠ¸
  function updateGraduateSchool(index, field, value) {
    if (formData.graduateSchools[index]) {
      formData.graduateSchools[index][field] = value;

      // ì¬í•™ì¤‘ ì²´í¬ë°•ìŠ¤ê°€ ë³€ê²½ë˜ë©´ ì¡¸ì—…ì¼ í•„ë“œ ë¹„í™œì„±í™”/í™œì„±í™”
      if (field === 'isCurrent') {
        const container = document.getElementById('graduate-schools');
        const graduateDiv = container.children[index];
        const graduationInput = graduateDiv.querySelector('input[data-field="graduation"]');
        if (graduationInput) {
          graduationInput.disabled = value;
          if (value) {
            graduationInput.value = '';
            formData.graduateSchools[index].graduationDate = '';
          }
        }
      }
    }
  }

  // ëŒ€í•™ì› ì œê±°
  function removeGraduateSchool(index) {
    const container = document.getElementById('graduate-schools');
    container.children[index].remove();
    formData.graduateSchools.splice(index, 1);
  }

  // ê²½ë ¥ ì¶”ê°€
  function addCareer() {
    const container = document.getElementById('careers');
    const index = formData.careers.length;

    const careerDiv = document.createElement('div');
    careerDiv.className = 'dynamic-item';
    careerDiv.innerHTML = `
      <button type="button" class="remove-btn" onclick="removeCareer(${index})">Ã—</button>
      <div class="form-content">
        <div class="form-row">
          <div class="form-group">
            <label>íšŒì‚¬ëª…</label>
            <input type="text" placeholder="íšŒì‚¬ëª…" onchange="updateCareer(${index}, 'companyName', this.value)">
          </div>
          <div class="form-group">
            <label>ë¶€ì„œ</label>
            <input type="text" placeholder="ë¶€ì„œ" onchange="updateCareer(${index}, 'department', this.value)">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>ì…ì‚¬ì¼</label>
            <input type="date" data-field="start" onchange="updateCareer(${index}, 'startDate', this.value)">
          </div>
          <div class="form-group">
            <label>í‡´ì‚¬ì¼</label>
            <input type="date" data-field="end" onchange="updateCareer(${index}, 'endDate', this.value)">
          </div>
        </div>
        <div class="form-group">
          <label>ì§ê¸‰</label>
          <input type="text" placeholder="ì§ê¸‰" onchange="updateCareer(${index}, 'positionTitle', this.value)">
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" onchange="updateCareer(${index}, 'isCurrent', this.checked)">
            <span>ì¬ì§ì¤‘</span>
          </label>
        </div>
        <div class="form-group">
          <label>ë‹´ë‹¹ì—…ë¬´</label>
          <textarea placeholder="ë‹´ë‹¹ì—…ë¬´ë¥¼ ìƒì„¸íˆ ì…ë ¥í•˜ì„¸ìš”" rows="3" onchange="updateCareer(${index}, 'responsibilities', this.value)"></textarea>
        </div>
        <div class="form-group">
          <label>í‡´ì‚¬ ì‚¬ìœ </label>
          <input type="text" placeholder="í‡´ì‚¬ ì‚¬ìœ " onchange="updateCareer(${index}, 'resignationReason', this.value)">
        </div>
      </div>
    `;

    container.appendChild(careerDiv);
    formData.careers.push({
      companyName: '', department: '', positionTitle: '',
      startDate: '', endDate: '', isCurrent: false,
      responsibilities: '', resignationReason: ''
    });
  }

  // ê²½ë ¥ ì •ë³´ ì—…ë°ì´íŠ¸
  function updateCareer(index, field, value) {
    if (formData.careers[index]) {
      formData.careers[index][field] = value;

      // ì¬ì§ì¤‘ ì²´í¬ë°•ìŠ¤ê°€ ë³€ê²½ë˜ë©´ í‡´ì‚¬ì¼ í•„ë“œ ë¹„í™œì„±í™”/í™œì„±í™”
      if (field === 'isCurrent') {
        const container = document.getElementById('careers');
        const careerDiv = container.children[index];
        const endDateInput = careerDiv.querySelector('input[data-field="end"]');
        if (endDateInput) {
          endDateInput.disabled = value;
          if (value) {
            endDateInput.value = '';
            formData.careers[index].endDate = '';
          }
        }
      }
    }
  }

  // ê²½ë ¥ ì œê±°
  function removeCareer(index) {
    const container = document.getElementById('careers');
    container.children[index].remove();
    formData.careers.splice(index, 1);
  }

  // í™œë™ ì¶”ê°€
  function addExperience() {
    const container = document.getElementById('experiences');
    const index = formData.experiences.length;

    const experienceDiv = document.createElement('div');
    experienceDiv.className = 'dynamic-item';
    experienceDiv.innerHTML = `
      <button type="button" class="remove-btn" onclick="removeExperience(${index})">Ã—</button>
      <div class="form-content">
        <div class="form-row">
          <div class="form-group">
            <label>í™œë™ëª…</label>
            <input type="text" placeholder="í™œë™ëª…" onchange="updateExperience(${index}, 'activityName', this.value)">
          </div>
          <div class="form-group">
            <label>ê¸°ê´€/ì¥ì†Œ</label>
            <input type="text" placeholder="ê¸°ê´€ëª… ë˜ëŠ” ì¥ì†Œ" onchange="updateExperience(${index}, 'institution', this.value)">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>ì‹œì‘ì¼</label>
            <input type="date" data-field="start" onchange="updateExperience(${index}, 'startDate', this.value)">
          </div>
          <div class="form-group">
            <label>ì¢…ë£Œì¼</label>
            <input type="date" data-field="end" onchange="updateExperience(${index}, 'endDate', this.value)">
          </div>
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" onchange="updateExperience(${index}, 'isCurrent', this.checked)">
            <span>ì§„í–‰ì¤‘</span>
          </label>
        </div>
        <div class="form-group">
          <label>ë‚´ìš©</label>
          <textarea placeholder="í™œë™ ë‚´ìš©ì„ ìƒì„¸íˆ ì…ë ¥í•˜ì„¸ìš”" rows="3" onchange="updateExperience(${index}, 'content', this.value)"></textarea>
        </div>
      </div>
    `;

    container.appendChild(experienceDiv);
    formData.experiences.push({
      activityName: '', institution: '',
      startDate: '', endDate: '', isCurrent: false, content: ''
    });
  }

  // í™œë™ ì •ë³´ ì—…ë°ì´íŠ¸
  function updateExperience(index, field, value) {
    if (formData.experiences[index]) {
      formData.experiences[index][field] = value;

      // ì§„í–‰ì¤‘ ì²´í¬ë°•ìŠ¤ê°€ ë³€ê²½ë˜ë©´ ì¢…ë£Œì¼ í•„ë“œ ë¹„í™œì„±í™”/í™œì„±í™”
      if (field === 'isCurrent') {
        const container = document.getElementById('experiences');
        const experienceDiv = container.children[index];
        const endDateInput = experienceDiv.querySelector('input[data-field="end"]');
        if (endDateInput) {
          endDateInput.disabled = value;
          if (value) {
            endDateInput.value = '';
            formData.experiences[index].endDate = '';
          }
        }
      }
    }
  }

  // í™œë™ ì œê±°
  function removeExperience(index) {
    const container = document.getElementById('experiences');
    container.children[index].remove();
    formData.experiences.splice(index, 1);
  }

  // í¼ ì œì¶œ
  async function handleSubmit() {
    // ì œëª©ì´ ë¹„ì–´ìˆìœ¼ë©´ placeholder ê°’ ì‚¬ìš©
    if (!formData.title.trim()) {
      const titleInput = document.getElementById('title');
      formData.title = titleInput.placeholder;
    }

    const submitBtn = document.querySelector('.submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = isEditMode ? 'ìˆ˜ì • ì¤‘...' : 'ìƒì„± ì¤‘...';

    try {
      console.log('=== ì œì¶œ ì „ ë°ì´í„° ê²€ì¦ ===');
      console.log('Original formData:', formData);

      // ë¹ˆ ë¬¸ìì—´ì„ nullë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
      const cleanStringValue = (value) => {
        return (value && value.trim() !== '') ? value.trim() : null;
      };

      // ì •ë¦¬ëœ ìš”ì²­ ë°ì´í„° ì¤€ë¹„
      const requestData = {
        title: formData.title || (isEditMode ? 'ì´ë ¥ì„œ' : `ì´ë ¥ì„œ ${String(resumeCounter).padStart(2, '0')}`),
        industry: cleanStringValue(formData.industry),
        position: cleanStringValue(formData.position),
        targetCompany: cleanStringValue(formData.targetCompany),
        highlights: cleanStringValue(formData.highlights)
      };

      console.log('ì „ì†¡í•  ìš”ì²­ ë°ì´í„°:', requestData);

      let resumeId;

      if (isEditMode) {
        // ê¸°ì¡´ ì´ë ¥ì„œ ìˆ˜ì •
        const resumeResponse = await fetch(`/api/resumes/${currentResumeId}`, {
          method: 'PUT',
          headers: getCSRFHeaders(),
          body: JSON.stringify(requestData)
        });

        if (!resumeResponse.ok) {
          const errorText = await resumeResponse.text();
          console.error('Resume Update API Error:', {
            status: resumeResponse.status,
            statusText: resumeResponse.statusText,
            errorBody: errorText
          });
          throw new Error(`ì´ë ¥ì„œ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${resumeResponse.status}): ${errorText}`);
        }

        const resume = await resumeResponse.json();
        resumeId = resume.id;
      } else {
        // ìƒˆ ì´ë ¥ì„œ ìƒì„±
        const resumeResponse = await fetch('/api/resumes', {
          method: 'POST',
          headers: getCSRFHeaders(),
          body: JSON.stringify(requestData)
        });

        if (!resumeResponse.ok) {
          const errorText = await resumeResponse.text();
          console.error('Resume API Error:', {
            status: resumeResponse.status,
            statusText: resumeResponse.statusText,
            errorBody: errorText
          });
          throw new Error(`ì´ë ¥ì„œ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${resumeResponse.status}): ${errorText}`);
        }

        const resume = await resumeResponse.json();
        resumeId = resume.id;
      }

      // 2. ê³ ë“±í•™êµ ì •ë³´ ì €ì¥ (í•™êµëª…ì´ ì‹¤ì œë¡œ ì…ë ¥ëœ ê²½ìš°ë§Œ)
      if (formData.highschool.schoolName && formData.highschool.schoolName.trim() !== '') {
        await fetch(`/api/resumes/${resumeId}/educations`, {
          method: 'POST',
          headers: getCSRFHeaders(),
          body: JSON.stringify({
            type: 'HIGH_SCHOOL',
            schoolName: formData.highschool.schoolName.trim(),
            graduationDate: formData.highschool.graduationYear ? formData.highschool.graduationYear + '-03-01' : null,
            isCurrent: false
          })
        });
      }

      // 3. ëŒ€í•™êµ ì •ë³´ ì €ì¥ (í•™êµëª…ì´ ì‹¤ì œë¡œ ì…ë ¥ëœ ê²½ìš°ë§Œ)
      for (const university of formData.universities) {
        if (university.schoolName && university.schoolName.trim() !== '') {
          await fetch(`/api/resumes/${resumeId}/educations`, {
            method: 'POST',
            headers: getCSRFHeaders(),
            body: JSON.stringify({
              type: 'UNIVERSITY',
              schoolName: university.schoolName.trim(),
              level: university.type || null,
              major: university.major || null,
              additionalMajor: university.additionalMajor || null,
              admissionDate: university.admissionDate || null,
              graduationDate: university.graduationDate || null,
              isCurrent: university.isCurrent || false
            })
          });
        }
      }

      // 4. ëŒ€í•™ì› ì •ë³´ ì €ì¥ (í•™êµëª…ì´ ì‹¤ì œë¡œ ì…ë ¥ëœ ê²½ìš°ë§Œ)
      for (const graduate of formData.graduateSchools) {
        if (graduate.schoolName && graduate.schoolName.trim() !== '') {
          await fetch(`/api/resumes/${resumeId}/educations`, {
            method: 'POST',
            headers: getCSRFHeaders(),
            body: JSON.stringify({
              type: 'GRADUATE_SCHOOL',
              schoolName: graduate.schoolName.trim(),
              level: graduate.type || null,
              major: graduate.major || null,
              admissionDate: graduate.admissionDate || null,
              graduationDate: graduate.graduationDate || null,
              isCurrent: graduate.isCurrent || false
            })
          });
        }
      }

      // 5. ê²½ë ¥ ì •ë³´ ì €ì¥ (íšŒì‚¬ëª…ì´ ì‹¤ì œë¡œ ì…ë ¥ëœ ê²½ìš°ë§Œ)
      for (const career of formData.careers) {
        if (career.companyName && career.companyName.trim() !== '') {
          await fetch(`/api/resumes/${resumeId}/careers`, {
            method: 'POST',
            headers: getCSRFHeaders(),
            body: JSON.stringify({
              companyName: career.companyName.trim(),
              department: career.department || null,
              positionTitle: career.positionTitle || null,
              startDate: career.startDate || null,
              endDate: career.endDate || null,
              isCurrent: career.isCurrent || false,
              responsibilities: career.responsibilities || null,
              resignationReason: career.resignationReason || null
            })
          });
        }
      }

      // 6. í™œë™ ì •ë³´ ì €ì¥ (í™œë™ëª…ì´ ì‹¤ì œë¡œ ì…ë ¥ëœ ê²½ìš°ë§Œ)
      for (const experience of formData.experiences) {
        if (experience.activityName && experience.activityName.trim() !== '') {
          await fetch(`/api/resumes/${resumeId}/experiences`, {
            method: 'POST',
            headers: getCSRFHeaders(),
            body: JSON.stringify({
              activityName: experience.activityName.trim(),
              institution: experience.institution || null,
              startDate: experience.startDate || null,
              endDate: experience.endDate || null,
              isCurrent: experience.isCurrent || false,
              content: experience.content || null
            })
          });
        }
      }

      // 7. Geminië¥¼ í†µí•œ ìì†Œì„œ ìƒì„± ìš”ì²­
      const geminiResponse = await fetch(`/gemini/generate/${resumeId}`, {
        method: 'POST',
        headers: getCSRFHeaders()
      });

      if (!geminiResponse.ok) {
        console.warn('ìì†Œì„œ ìƒì„±ì— ì‹¤íŒ¨í–ˆì§€ë§Œ ì´ë ¥ì„œëŠ” ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }

      alert(isEditMode ? 'ì´ë ¥ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ì´ë ¥ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');

      // ë‹¤ìŒ ì´ë ¥ì„œë¥¼ ìœ„í•´ ì¹´ìš´í„° ì¦ê°€ (ìƒˆ ì‘ì„±ì¸ ê²½ìš°ë§Œ)
      if (!isEditMode) {
        resumeCounter++;
      }

      // Gemini ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
      window.location.href = `/resumes/result?resumeId=${resumeId}`;

    } catch (error) {
      console.error('Error:', error);
      if (error.name === 'SyntaxError' && error.message.includes('Unexpected token')) {
        alert('ì„œë²„ ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
      } else {
        alert(`${isEditMode ? 'ìˆ˜ì •' : 'ì €ì¥'} ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ` + error.message);
      }
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = isEditMode ? 'AI ì´ë ¥ì„œ ìˆ˜ì •' : 'AI ì´ë ¥ì„œ ìƒì„±';
    }
  }

  // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>