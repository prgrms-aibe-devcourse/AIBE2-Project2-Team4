<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
  <title id="pageTitle">이력서 작성</title>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

  <!-- 페이지별 추가 CSS -->
  <th:block layout:fragment="css">
    <style>
      /* 페이지 헤더 */
      .page-header {
        background: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 2rem 0;
      }

      .page-header-content {
        max-width: 64rem;
        margin: 0 auto;
        padding: 0 1rem;
        text-align: center;
      }

      .page-header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.5rem;
      }

      .page-header p {
        color: #6b7280;
      }

      /* 메인 컨테이너 */
      .main-content .container {
        max-width: 96rem !important;
        margin: 0 auto !important;
        padding: 2rem 4rem 2rem 8rem !important;
        display: flex;
        gap: 2rem;
      }

      .content-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 3rem;
      }

      /* 섹션 스타일 */
      .section {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
      }

      .section-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #2563eb;
        margin-bottom: 1.5rem;
      }

      /* 폼 요소 */
      .form-group {
        margin-bottom: 1rem;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
        padding-left: 0.5rem;
      }

      input, select, textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      }

      select {
        padding-right: 2.5rem;
        background: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>') no-repeat right 0.75rem center;
        background-size: 1rem;
        appearance: none;
      }

      textarea {
        resize: none;
      }

      input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      /* 교육 하위 섹션 */
      .education-subsection {
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        background: #fafbfc;
      }

      .education-subsection h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #374151;
        margin: 1rem 0 1rem 0;
        padding-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      /* 각 교육 섹션별 아이콘 추가 */
      .education-subsection h3::before {
        font-size: 1.1rem;
      }

      /* 동적 항목 */
      .dynamic-item {
        background: #f9fafb;
        padding: 0.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        position: relative;
      }

      .form-content {
        margin-top: 1.5rem;
      }

      .remove-btn {
        position: absolute;
        right: 0.5rem;
        background: none;
        color: #ef4444;
        border: none;
        width: 2.5rem;
        height: 2.5rem;
        cursor: pointer;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.25rem;
        transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out;
      }

      .remove-btn:hover {
        color: #dc2626;
        background: rgba(239, 68, 68, 0.1);
      }

      .add-btn {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #93c5fd;
        background: transparent;
        color: #2563eb;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.875rem;
        transition: background-color 0.15s ease-in-out;
      }

      .add-btn:hover {
        background: #dbeafe;
      }

      /* 사이드바 */
      .sidebar {
        width: 16rem;
      }

      .sidebar-fixed {
        position: sticky;
        top: 1rem;
        width: 16rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        align-self: flex-start;
      }

      .menu-card {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 1rem;
      }

      .menu-title {
        font-size: 0.875rem;
        font-weight: 700;
        color: #2563eb;
        margin-bottom: 1rem;
        text-align: center;
      }

      .menu-nav {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .menu-item {
        width: 100%;
        text-align: left;
        padding: 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        background: transparent;
        border: none;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.15s ease-in-out;
      }

      .menu-item:hover {
        color: #1f2937;
        background: #f9fafb;
      }

      .submit-btn {
        width: 100%;
        background: #2563eb;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        border: none;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.15s ease-in-out;
      }

      .submit-btn:hover {
        background: #1d4ed8;
      }

      .submit-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }

      /* 체크박스 라벨 */
      .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: #374151;
        cursor: pointer;
      }

      .checkbox-label input[type="checkbox"] {
        width: auto;
        margin: 0;
      }

      /* 로딩 상태 */
      .loading {
        display: none;
        text-align: center;
        padding: 4rem;
        color: #6b7280;
      }

      .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #e5e7eb;
        border-radius: 50%;
        border-top-color: #3b82f6;
        animation: spin 1s ease-in-out infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* 반응형 디자인 */
      @media (max-width: 768px) {
        .main-content .container {
          flex-direction: column !important;
          padding: 1rem 1rem 1rem 2rem !important;
        }

        .sidebar {
          width: 100%;
          order: -1;
        }

        .sidebar-fixed {
          position: static;
          width: 100%;
        }

        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </th:block>
</head>

<body>
<!-- 메인 콘텐츠 -->
<div layout:fragment="content">
  <!-- 페이지 헤더 -->
  <div class="page-header">
    <div class="page-header-content">
      <h1 id="headerTitle">이력서 작성</h1>
      <p id="headerDescription">나만의 특별한 이력서로 원하는 취업에 도전하세요.</p>
    </div>
  </div>

  <!-- 로딩 상태 -->
  <div id="loadingState" class="loading">
    <div class="spinner"></div>
    <p>이력서 정보를 불러오는 중...</p>
  </div>

  <div class="container" id="mainContainer" style="display: none;">
    <div class="content-area">
      <!-- 제목 섹션 -->
      <section id="basic" class="section">
        <h2 class="section-title">제목</h2>
        <input
                type="text"
                id="title"
                placeholder="이력서 01"
        >
      </section>

      <!-- 직무 및 업종 -->
      <section id="job" class="section">
        <h2 class="section-title">직무 및 업종</h2>
        <div class="form-group">
          <label for="industry">업종</label>
          <select id="industry">
            <option value="">관심있는 기업의 업종을 알고 있나요? 😊</option>
            <option value="IT/소프트웨어">IT/소프트웨어</option>
            <option value="제조업">제조업</option>
            <option value="금융">금융</option>
            <option value="교육">교육</option>
            <option value="의료/바이오">의료/바이오</option>
            <option value="건설/부동산">건설/부동산</option>
            <option value="유통/물류">유통/물류</option>
            <option value="미디어/광고">미디어/광고</option>
            <option value="서비스업">서비스업</option>
            <option value="기타">기타</option>
          </select>
        </div>
        <div class="form-group">
          <label for="position">직무</label>
          <select id="position" disabled>
            <option value="">먼저 업종을 선택해 주세요</option>
          </select>
        </div>
        <div class="form-group">
          <label for="target-company">목표 회사</label>
          <input
                  type="text"
                  id="target-company"
                  placeholder="목표 회사명을 입력하세요"
          >
        </div>
      </section>

      <!-- 학력 섹션 -->
      <section id="education" class="section">
        <h2 class="section-title">학력</h2>

        <!-- 고등학교 -->
        <div class="education-subsection">
          <h3>고등학교</h3>
          <div class="form-row">
            <div class="form-group">
              <label>학교명</label>
              <input type="text" id="highschool-name" placeholder="고등학교명">
            </div>
            <div class="form-group">
              <label>졸업년도</label>
              <select id="highschool-year">
                <option value="">졸업년도 선택</option>
              </select>
            </div>
          </div>
        </div>

        <!-- 대학교 -->
        <div class="education-subsection">
          <h3>대학교</h3>
          <div id="universities"></div>
          <button type="button" class="add-btn" onclick="addUniversity()">+ 대학교 추가</button>
        </div>

        <!-- 대학원 -->
        <div class="education-subsection">
          <h3>대학원</h3>
          <div id="graduate-schools"></div>
          <button type="button" class="add-btn" onclick="addGraduateSchool()">+ 대학원 추가</button>
        </div>
      </section>

      <!-- 경력 섹션 -->
      <section id="career" class="section">
        <h2 class="section-title">경력</h2>
        <div id="careers"></div>
        <button type="button" class="add-btn" onclick="addCareer()">+ 경력 추가</button>
      </section>

      <!-- 활동 섹션 -->
      <section id="experience" class="section">
        <h2 class="section-title">활동</h2>
        <div id="experiences"></div>
        <button type="button" class="add-btn" onclick="addExperience()">+ 활동 추가</button>
      </section>

      <!-- 강조 포인트 섹션 -->
      <section id="highlights" class="section" style="margin-bottom: 5rem;">
        <h2 class="section-title">강조 포인트</h2>
        <div class="form-group">
          <label for="highlights-text">강조하고 싶은 내용</label>
          <textarea
                  id="highlights-text"
                  rows="6"
                  placeholder="자신의 강점, 특별한 경험, 성과 등을 자유롭게 입력하세요"
          ></textarea>
        </div>
      </section>
    </div>

    <!-- 사이드바 -->
    <div class="sidebar">
      <div class="sidebar-fixed">
        <div class="menu-card">
          <h3 class="menu-title">목차</h3>
          <nav class="menu-nav">
            <button class="menu-item" onclick="scrollToSection('basic')">제목</button>
            <button class="menu-item" onclick="scrollToSection('job')">업종 및 직무</button>
            <button class="menu-item" onclick="scrollToSection('education')">학력</button>
            <button class="menu-item" onclick="scrollToSection('career')">경력</button>
            <button class="menu-item" onclick="scrollToSection('experience')">활동</button>
            <button class="menu-item" onclick="scrollToSection('highlights')">강조 포인트</button>
          </nav>
        </div>

        <button class="submit-btn" onclick="handleSubmit()" id="submitBtn">AI 이력서 생성</button>
      </div>
    </div>
  </div>
</div>

<!-- 페이지별 JavaScript -->
<th:block layout:fragment="script">
  <script>
    // 전역 변수
    let isEditMode = false;
    let currentResumeId = null;
    let formData = {
      title: '',
      industry: '',
      position: '',
      targetCompany: '',
      highlights: '',
      highschool: { schoolName: '', graduationYear: '' },
      universities: [],
      graduateSchools: [],
      careers: [],
      experiences: []
    };

    let resumeCounter = 1; // 기본값, 실제로는 서버에서 조회해서 설정

    // 업종별 직무 매핑
    const industryToPositionMapping = {
      'IT/소프트웨어': ['웹개발', '앱개발', '프론트엔드', '백엔드', '풀스택', '데이터분석', 'AI/ML', '보안', '네트워크', '시스템관리', 'QA', 'UI/UX', '웹디자인'],
      '제조업': ['생산관리', '품질관리', '공정관리', '제조기술', '설비관리', '연구개발', '제품개발'],
      '금융': ['경영기획', '사업기획', '재무', '회계', '법무', '리스크관리', '투자분석', '보험심사'],
      '교육': ['초등교사', '중등교사', '고등교사', '강사', '교육기획', '교육컨설팅'],
      '의료/바이오': ['의사', '간호사', '약사', '물리치료사', '의료기기', '연구개발', '기술연구'],
      '건설/부동산': ['건축설계', '토목설계', '시공관리', '안전관리', '부동산개발', '부동산컨설팅'],
      '유통/물류': ['무역사무', '해외영업', '구매', '물류', '유통', 'MD', '상품기획'],
      '미디어/광고': ['마케팅기획', '브랜드마케팅', '디지털마케팅', '광고기획', '홍보', 'PR', '그래픽디자인', '콘텐츠기획'],
      '서비스업': ['기업영업', '개인영업', '내근영업', '고객상담', '텔레마케팅', '서비스기획'],
      '기타': ['경영기획', '사업기획', '총무', '인사', '마케팅기획', '영업', '기타']
    };

    // CSRF 토큰 가져오기
    function getCSRFHeaders() {
      const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
      const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

      const headers = {
        'Content-Type': 'application/json',
      };

      if (token && header) {
        headers[header] = token;
      }

      return headers;
    }

    // URL에서 resumeId 파라미터 추출
    function getResumeIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('resumeId');
    }

    // 기존 이력서 개수 조회하여 다음 번호 설정
    async function loadResumeCount() {
      try {
        const response = await fetch('/api/resumes', {
          method: 'GET',
          headers: getCSRFHeaders()
        });

        if (response.ok) {
          const resumes = await response.json();
          resumeCounter = resumes.length + 1;
          console.log(`기존 이력서 ${resumes.length}개, 다음 번호: ${resumeCounter}`);
        } else {
          console.warn('이력서 목록 조회 실패, 기본 번호 사용');
          resumeCounter = 1;
        }
      } catch (error) {
        console.error('이력서 개수 조회 중 오류:', error);
        resumeCounter = 1;
      }
    }

    // 페이지 초기화
    async function init() {
      console.log('페이지 초기화 시작');

      setupYearOptions();

      const resumeId = getResumeIdFromUrl();
      console.log('Resume ID:', resumeId);

      if (resumeId) {
        // 편집 모드
        isEditMode = true;
        currentResumeId = resumeId;
        console.log('편집 모드로 설정');

        // UI 변경 (null 체크 추가)
        const pageTitle = document.getElementById('pageTitle');
        const headerTitle = document.getElementById('headerTitle');
        const headerDescription = document.getElementById('headerDescription');
        const submitBtn = document.getElementById('submitBtn');

        if (pageTitle) pageTitle.textContent = '이력서 수정';
        if (headerTitle) headerTitle.textContent = '이력서 수정';
        if (headerDescription) headerDescription.textContent = '기존 이력서 정보를 수정하세요.';
        if (submitBtn) submitBtn.textContent = 'AI 이력서 수정';

        // 기존 데이터 로드
        console.log('기존 데이터 로드 시작');
        await loadExistingData(resumeId);
      } else {
        // 새 작성 모드
        console.log('새 작성 모드로 설정');
        isEditMode = false;
        await loadResumeCount();
        setDefaultTitle();
        hideLoading();
      }

      setupEventListeners();
      console.log('페이지 초기화 완료');
    }

    // 기존 데이터 로드
    async function loadExistingData(resumeId) {
      try {
        console.log('기존 데이터 로드 시작, Resume ID:', resumeId);
        showLoading();

        const response = await fetch(`/api/resumes/${resumeId}`, {
          method: 'GET',
          headers: getCSRFHeaders()
        });

        console.log('API 응답 상태:', response.status);

        if (response.ok) {
          const resumeData = await response.json();
          console.log('받은 데이터:', resumeData);
          populateFormWithData(resumeData);
          hideLoading();
          console.log('데이터 로드 완료');
        } else {
          const errorText = await response.text();
          console.error('API 에러:', response.status, errorText);
          throw new Error(`이력서 데이터를 불러올 수 없습니다. (${response.status})`);
        }
      } catch (error) {
        console.error('Load error:', error);
        hideLoading(); // 에러 시에도 로딩 숨김

        // 사용자에게 알림 후 새 작성 모드로 전환
        const message = `이력서 데이터를 불러오는 중 오류가 발생했습니다: ${error.message}\n\n새 이력서 작성 모드로 전환합니다.`;
        alert(message);

        // 새 작성 모드로 전환
        isEditMode = false;
        currentResumeId = null;

        // URL에서 resumeId 파라미터 제거
        const url = new URL(window.location);
        url.searchParams.delete('resumeId');
        window.history.replaceState({}, '', url);

        // UI 업데이트
        const headerTitle = document.getElementById('headerTitle');
        const headerDescription = document.getElementById('headerDescription');
        const submitBtn = document.getElementById('submitBtn');

        if (headerTitle) headerTitle.textContent = '이력서 작성';
        if (headerDescription) headerDescription.textContent = '나만의 특별한 이력서로 원하는 취업에 도전하세요.';
        if (submitBtn) submitBtn.textContent = 'AI 이력서 생성';

        await loadResumeCount();
        setDefaultTitle();
      }
    }

    // 폼에 기존 데이터 채우기
    function populateFormWithData(resumeData) {
      console.log('폼 데이터 채우기 시작:', resumeData);

      // 안전한 요소 접근을 위한 헬퍼 함수
      const safeSetValue = (id, value) => {
        const element = document.getElementById(id);
        if (element) {
          element.value = value || '';
        } else {
          console.warn(`Element not found: ${id}`);
        }
      };

      // 기본 정보
      safeSetValue('title', resumeData.title);
      safeSetValue('target-company', resumeData.targetCompany);
      safeSetValue('highlights-text', resumeData.highlights);

      // 업종/직무
      if (resumeData.industry) {
        safeSetValue('industry', resumeData.industry);
        updatePositionOptions();
        if (resumeData.position) {
          safeSetValue('position', resumeData.position);
        }
      }

      // formData 업데이트
      formData.title = resumeData.title || '';
      formData.industry = resumeData.industry || '';
      formData.position = resumeData.position || '';
      formData.targetCompany = resumeData.targetCompany || '';
      formData.highlights = resumeData.highlights || '';

      // 학력 정보 처리
      if (resumeData.educations) {
        const highSchool = resumeData.educations.find(edu => edu.type === 'HIGH_SCHOOL');
        if (highSchool) {
          safeSetValue('highschool-name', highSchool.schoolName);
          if (highSchool.graduationDate) {
            const gradYear = new Date(highSchool.graduationDate).getFullYear();
            safeSetValue('highschool-year', gradYear);
          }
          formData.highschool.schoolName = highSchool.schoolName || '';
          formData.highschool.graduationYear = document.getElementById('highschool-year')?.value || '';
        }

        // 대학교
        const universities = resumeData.educations.filter(edu => edu.type === 'UNIVERSITY');
        universities.forEach(university => {
          addUniversity();
          const index = formData.universities.length - 1;
          formData.universities[index] = {
            schoolName: university.schoolName || '',
            type: university.level || '',
            major: university.major || '',
            additionalMajor: university.additionalMajor || '',
            admissionDate: university.admissionDate || '',
            graduationDate: university.graduationDate || '',
            isCurrent: university.isCurrent || false
          };
          updateUniversityDisplay(index);
        });

        // 대학원
        const graduateSchools = resumeData.educations.filter(edu => edu.type === 'GRADUATE_SCHOOL');
        graduateSchools.forEach(graduate => {
          addGraduateSchool();
          const index = formData.graduateSchools.length - 1;
          formData.graduateSchools[index] = {
            schoolName: graduate.schoolName || '',
            type: graduate.level || '',
            major: graduate.major || '',
            admissionDate: graduate.admissionDate || '',
            graduationDate: graduate.graduationDate || '',
            isCurrent: graduate.isCurrent || false
          };
          updateGraduateSchoolDisplay(index);
        });
      }

      // 경력 정보
      if (resumeData.careers) {
        resumeData.careers.forEach(career => {
          addCareer();
          const index = formData.careers.length - 1;
          formData.careers[index] = {
            companyName: career.companyName || '',
            department: career.department || '',
            positionTitle: career.positionTitle || '',
            startDate: career.startDate || '',
            endDate: career.endDate || '',
            isCurrent: career.isCurrent || false,
            responsibilities: career.responsibilities || '',
            resignationReason: career.resignationReason || ''
          };
          updateCareerDisplay(index);
        });
      }

      // 활동/경험
      if (resumeData.experiences) {
        resumeData.experiences.forEach(experience => {
          addExperience();
          const index = formData.experiences.length - 1;
          formData.experiences[index] = {
            activityName: experience.activityName || '',
            institution: experience.institution || '',
            startDate: experience.startDate || '',
            endDate: experience.endDate || '',
            isCurrent: experience.isCurrent || false,
            content: experience.content || ''
          };
          updateExperienceDisplay(index);
        });
      }

      console.log('폼 데이터 채우기 완료');
    }

    // 표시 업데이트 함수들
    function updateUniversityDisplay(index) {
      const container = document.getElementById('universities');
      const universityDiv = container.children[index];
      const data = formData.universities[index];

      universityDiv.querySelector('input[placeholder="대학교명"]').value = data.schoolName;
      universityDiv.querySelector('select').value = data.type;
      const inputs = universityDiv.querySelectorAll('input');
      inputs[1].value = data.admissionDate;
      inputs[2].value = data.graduationDate;
      inputs[3].value = data.major;
      inputs[4].value = data.additionalMajor;
      universityDiv.querySelector('input[type="checkbox"]').checked = data.isCurrent;
    }

    function updateGraduateSchoolDisplay(index) {
      const container = document.getElementById('graduate-schools');
      const graduateDiv = container.children[index];
      const data = formData.graduateSchools[index];

      graduateDiv.querySelector('input[placeholder="대학원명"]').value = data.schoolName;
      graduateDiv.querySelector('select').value = data.type;
      const inputs = graduateDiv.querySelectorAll('input');
      inputs[1].value = data.admissionDate;
      inputs[2].value = data.graduationDate;
      inputs[3].value = data.major;
      graduateDiv.querySelector('input[type="checkbox"]').checked = data.isCurrent;
    }

    function updateCareerDisplay(index) {
      const container = document.getElementById('careers');
      const careerDiv = container.children[index];
      const data = formData.careers[index];

      const inputs = careerDiv.querySelectorAll('input');
      const textareas = careerDiv.querySelectorAll('textarea');

      inputs[0].value = data.companyName;
      inputs[1].value = data.department;
      inputs[2].value = data.startDate;
      inputs[3].value = data.endDate;
      inputs[4].value = data.positionTitle;
      careerDiv.querySelector('input[type="checkbox"]').checked = data.isCurrent;
      textareas[0].value = data.responsibilities;
      inputs[5].value = data.resignationReason;
    }

    function updateExperienceDisplay(index) {
      const container = document.getElementById('experiences');
      const experienceDiv = container.children[index];
      const data = formData.experiences[index];

      const inputs = experienceDiv.querySelectorAll('input');
      const textarea = experienceDiv.querySelector('textarea');

      inputs[0].value = data.activityName;
      inputs[1].value = data.institution;
      inputs[2].value = data.startDate;
      inputs[3].value = data.endDate;
      experienceDiv.querySelector('input[type="checkbox"]').checked = data.isCurrent;
      textarea.value = data.content;
    }

    // 로딩 상태 표시/숨김
    function showLoading() {
      console.log('로딩 표시');
      const loadingState = document.getElementById('loadingState');
      const mainContainer = document.getElementById('mainContainer');

      if (loadingState) loadingState.style.display = 'block';
      if (mainContainer) mainContainer.style.display = 'none';
    }

    function hideLoading() {
      console.log('로딩 숨김');
      const loadingState = document.getElementById('loadingState');
      const mainContainer = document.getElementById('mainContainer');

      if (loadingState) loadingState.style.display = 'none';
      if (mainContainer) mainContainer.style.display = 'flex';
    }

    // 기본 제목 설정
    function setDefaultTitle() {
      const titleInput = document.getElementById('title');
      const defaultTitle = `이력서 ${String(resumeCounter).padStart(2, '0')}`;
      titleInput.placeholder = defaultTitle;
      titleInput.value = '';
      formData.title = '';
      updateSubmitButton();
    }

    // 년도 옵션 설정
    function setupYearOptions() {
      const currentYear = new Date().getFullYear();
      const yearSelect = document.getElementById('highschool-year');

      for (let i = 0; i < 50; i++) {
        const year = currentYear - i;
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + '년';
        yearSelect.appendChild(option);
      }
    }

    // 이벤트 리스너 설정
    function setupEventListeners() {
      // 업종 변경 시 직무 업데이트
      document.getElementById('industry').addEventListener('change', function() {
        updatePositionOptions();
        formData.industry = this.value;
        formData.position = '';
        updateSubmitButton();
      });

      // 제목 입력 감지
      document.getElementById('title').addEventListener('input', function() {
        formData.title = this.value;
        updateSubmitButton();
      });

      // 직무 선택
      document.getElementById('position').addEventListener('change', function() {
        formData.position = this.value;
        updateSubmitButton();
      });

      // 목표 회사 입력
      document.getElementById('target-company').addEventListener('input', function() {
        formData.targetCompany = this.value;
      });

      // 강조 포인트
      document.getElementById('highlights-text').addEventListener('input', function() {
        formData.highlights = this.value;
      });

      // 고등학교 정보
      document.getElementById('highschool-name').addEventListener('input', function() {
        formData.highschool.schoolName = this.value;
      });

      document.getElementById('highschool-year').addEventListener('change', function() {
        formData.highschool.graduationYear = this.value;
      });
    }

    // 직무 옵션 업데이트
    function updatePositionOptions() {
      const industry = document.getElementById('industry').value;
      const positionSelect = document.getElementById('position');

      positionSelect.innerHTML = '';

      if (!industry) {
        positionSelect.disabled = true;
        positionSelect.innerHTML = '<option value="">먼저 업종을 선택해 주세요</option>';
        return;
      }

      positionSelect.disabled = false;
      positionSelect.innerHTML = '<option value="">직무를 선택해 주세요</option>';

      const positions = industryToPositionMapping[industry] || [];
      positions.forEach(position => {
        const option = document.createElement('option');
        option.value = position;
        option.textContent = position;
        positionSelect.appendChild(option);
      });
    }

    // 제출 버튼 상태 업데이트
    function updateSubmitButton() {
      const submitBtn = document.querySelector('.submit-btn');
      submitBtn.disabled = false;
    }

    // 스크롤 기능
    function scrollToSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    // 대학교 추가
    function addUniversity() {
      const container = document.getElementById('universities');
      const index = formData.universities.length;

      const universityDiv = document.createElement('div');
      universityDiv.className = 'dynamic-item';
      universityDiv.innerHTML = `
                  <button type="button" class="remove-btn" onclick="removeUniversity(${index})">×</button>
                  <div class="form-content">
                    <div class="form-row">
                      <div class="form-group">
                        <label>학교명</label>
                        <input type="text" placeholder="대학교명" onchange="updateUniversity(${index}, 'schoolName', this.value)">
                      </div>
                      <div class="form-group">
                        <label>분류</label>
                        <select onchange="updateUniversity(${index}, 'type', this.value)">
                          <option value="">선택</option>
                          <option value="2년제">2년제</option>
                          <option value="3년제">3년제</option>
                          <option value="4년제">4년제</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>입학</label>
                        <input type="month" data-field="admission" onchange="updateUniversity(${index}, 'admissionDate', this.value)">
                      </div>
                      <div class="form-group">
                        <label>졸업</label>
                        <input type="month" data-field="graduation" onchange="updateUniversity(${index}, 'graduationDate', this.value)">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>전공</label>
                        <input type="text" placeholder="전공" onchange="updateUniversity(${index}, 'major', this.value)">
                      </div>
                      <div class="form-group">
                        <label>추가전공</label>
                        <input type="text" placeholder="부전공, 복수전공 등" onchange="updateUniversity(${index}, 'additionalMajor', this.value)">
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="checkbox-label">
                        <input type="checkbox" onchange="updateUniversity(${index}, 'isCurrent', this.checked)">
                        <span>재학중</span>
                      </label>
                    </div>
                  </div>
                `;

      container.appendChild(universityDiv);
      formData.universities.push({
        schoolName: '', type: '', major: '', additionalMajor: '',
        admissionDate: '', graduationDate: '', isCurrent: false
      });
    }

    // 대학교 정보 업데이트
    function updateUniversity(index, field, value) {
      if (formData.universities[index]) {
        formData.universities[index][field] = value;

        if (field === 'isCurrent') {
          const container = document.getElementById('universities');
          const universityDiv = container.children[index];
          const graduationInput = universityDiv.querySelector('input[data-field="graduation"]');
          if (graduationInput) {
            graduationInput.disabled = value;
            if (value) {
              graduationInput.value = '';
              formData.universities[index].graduationDate = '';
            }
          }
        }
      }
    }

    // 대학교 제거
    function removeUniversity(index) {
      const container = document.getElementById('universities');
      container.children[index].remove();
      formData.universities.splice(index, 1);
      regenerateUniversities();
    }

    // 대학교 목록 재생성
    function regenerateUniversities() {
      const container = document.getElementById('universities');
      const universities = [...formData.universities];
      container.innerHTML = '';
      formData.universities = [];
      universities.forEach(() => addUniversity());
    }

    // 대학원 추가
    function addGraduateSchool() {
      const container = document.getElementById('graduate-schools');
      const index = formData.graduateSchools.length;

      const graduateDiv = document.createElement('div');
      graduateDiv.className = 'dynamic-item';
      graduateDiv.innerHTML = `
                  <button type="button" class="remove-btn" onclick="removeGraduateSchool(${index})">×</button>
                  <div class="form-content">
                    <div class="form-row">
                      <div class="form-group">
                        <label>학교명</label>
                        <input type="text" placeholder="대학원명" onchange="updateGraduateSchool(${index}, 'schoolName', this.value)">
                      </div>
                      <div class="form-group">
                        <label>과정</label>
                        <select onchange="updateGraduateSchool(${index}, 'type', this.value)">
                          <option value="">선택</option>
                          <option value="석사">석사</option>
                          <option value="박사">박사</option>
                          <option value="석박통합">석박통합</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>입학</label>
                        <input type="month" data-field="admission" onchange="updateGraduateSchool(${index}, 'admissionDate', this.value)">
                      </div>
                      <div class="form-group">
                        <label>졸업</label>
                        <input type="month" data-field="graduation" onchange="updateGraduateSchool(${index}, 'graduationDate', this.value)">
                      </div>
                    </div>
                    <div class="form-group">
                      <label>전공</label>
                      <input type="text" placeholder="전공" onchange="updateGraduateSchool(${index}, 'major', this.value)">
                    </div>
                    <div class="form-group">
                      <label class="checkbox-label">
                        <input type="checkbox" onchange="updateGraduateSchool(${index}, 'isCurrent', this.checked)">
                        <span>재학중</span>
                      </label>
                    </div>
                  </div>
                `;

      container.appendChild(graduateDiv);
      formData.graduateSchools.push({
        schoolName: '', type: '', major: '',
        admissionDate: '', graduationDate: '', isCurrent: false
      });
    }

    // 대학원 정보 업데이트
    function updateGraduateSchool(index, field, value) {
      if (formData.graduateSchools[index]) {
        formData.graduateSchools[index][field] = value;

        if (field === 'isCurrent') {
          const container = document.getElementById('graduate-schools');
          const graduateDiv = container.children[index];
          const graduationInput = graduateDiv.querySelector('input[data-field="graduation"]');
          if (graduationInput) {
            graduationInput.disabled = value;
            if (value) {
              graduationInput.value = '';
              formData.graduateSchools[index].graduationDate = '';
            }
          }
        }
      }
    }

    // 대학원 제거
    function removeGraduateSchool(index) {
      const container = document.getElementById('graduate-schools');
      container.children[index].remove();
      formData.graduateSchools.splice(index, 1);
    }

    // 경력 추가
    function addCareer() {
      const container = document.getElementById('careers');
      const index = formData.careers.length;

      const careerDiv = document.createElement('div');
      careerDiv.className = 'dynamic-item';
      careerDiv.innerHTML = `
                  <button type="button" class="remove-btn" onclick="removeCareer(${index})">×</button>
                  <div class="form-content">
                    <div class="form-row">
                      <div class="form-group">
                        <label>회사명</label>
                        <input type="text" placeholder="회사명" onchange="updateCareer(${index}, 'companyName', this.value)">
                      </div>
                      <div class="form-group">
                        <label>부서</label>
                        <input type="text" placeholder="부서" onchange="updateCareer(${index}, 'department', this.value)">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>입사일</label>
                        <input type="date" data-field="start" onchange="updateCareer(${index}, 'startDate', this.value)">
                      </div>
                      <div class="form-group">
                        <label>퇴사일</label>
                        <input type="date" data-field="end" onchange="updateCareer(${index}, 'endDate', this.value)">
                      </div>
                    </div>
                    <div class="form-group">
                      <label>직급</label>
                      <input type="text" placeholder="직급" onchange="updateCareer(${index}, 'positionTitle', this.value)">
                    </div>
                    <div class="form-group">
                      <label class="checkbox-label">
                        <input type="checkbox" onchange="updateCareer(${index}, 'isCurrent', this.checked)">
                        <span>재직중</span>
                      </label>
                    </div>
                    <div class="form-group">
                      <label>담당업무</label>
                      <textarea placeholder="담당업무를 상세히 입력하세요" rows="3" onchange="updateCareer(${index}, 'responsibilities', this.value)"></textarea>
                    </div>
                    <div class="form-group">
                      <label>퇴사 사유</label>
                      <input type="text" placeholder="퇴사 사유" onchange="updateCareer(${index}, 'resignationReason', this.value)">
                    </div>
                  </div>
                `;

      container.appendChild(careerDiv);
      formData.careers.push({
        companyName: '', department: '', positionTitle: '',
        startDate: '', endDate: '', isCurrent: false,
        responsibilities: '', resignationReason: ''
      });
    }

    // 경력 정보 업데이트
    function updateCareer(index, field, value) {
      if (formData.careers[index]) {
        formData.careers[index][field] = value;

        if (field === 'isCurrent') {
          const container = document.getElementById('careers');
          const careerDiv = container.children[index];
          const endDateInput = careerDiv.querySelector('input[data-field="end"]');
          if (endDateInput) {
            endDateInput.disabled = value;
            if (value) {
              endDateInput.value = '';
              formData.careers[index].endDate = '';
            }
          }
        }
      }
    }

    // 경력 제거
    function removeCareer(index) {
      const container = document.getElementById('careers');
      container.children[index].remove();
      formData.careers.splice(index, 1);
    }

    // 활동 추가
    function addExperience() {
      const container = document.getElementById('experiences');
      const index = formData.experiences.length;

      const experienceDiv = document.createElement('div');
      experienceDiv.className = 'dynamic-item';
      experienceDiv.innerHTML = `
                  <button type="button" class="remove-btn" onclick="removeExperience(${index})">×</button>
                  <div class="form-content">
                    <div class="form-row">
                      <div class="form-group">
                        <label>활동명</label>
                        <input type="text" placeholder="활동명" onchange="updateExperience(${index}, 'activityName', this.value)">
                      </div>
                      <div class="form-group">
                        <label>기관/장소</label>
                        <input type="text" placeholder="기관명 또는 장소" onchange="updateExperience(${index}, 'institution', this.value)">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>시작일</label>
                        <input type="date" data-field="start" onchange="updateExperience(${index}, 'startDate', this.value)">
                      </div>
                      <div class="form-group">
                        <label>종료일</label>
                        <input type="date" data-field="end" onchange="updateExperience(${index}, 'endDate', this.value)">
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="checkbox-label">
                        <input type="checkbox" onchange="updateExperience(${index}, 'isCurrent', this.checked)">
                        <span>진행중</span>
                      </label>
                    </div>
                    <div class="form-group">
                      <label>내용</label>
                      <textarea placeholder="활동 내용을 상세히 입력하세요" rows="3" onchange="updateExperience(${index}, 'content', this.value)"></textarea>
                    </div>
                  </div>
                `;

      container.appendChild(experienceDiv);
      formData.experiences.push({
        activityName: '', institution: '',
        startDate: '', endDate: '', isCurrent: false, content: ''
      });
    }

    // 활동 정보 업데이트
    function updateExperience(index, field, value) {
      if (formData.experiences[index]) {
        formData.experiences[index][field] = value;

        if (field === 'isCurrent') {
          const container = document.getElementById('experiences');
          const experienceDiv = container.children[index];
          const endDateInput = experienceDiv.querySelector('input[data-field="end"]');
          if (endDateInput) {
            endDateInput.disabled = value;
            if (value) {
              endDateInput.value = '';
              formData.experiences[index].endDate = '';
            }
          }
        }
      }
    }

    // 활동 제거
    function removeExperience(index) {
      const container = document.getElementById('experiences');
      container.children[index].remove();
      formData.experiences.splice(index, 1);
    }

    // 폼 제출
    async function handleSubmit() {
      if (!formData.title.trim()) {
        const titleInput = document.getElementById('title');
        formData.title = titleInput.placeholder;
      }

      const submitBtn = document.querySelector('.submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = isEditMode ? '수정 중...' : '생성 중...';

      try {
        console.log('=== 제출 전 데이터 검증 ===');
        console.log('Original formData:', formData);

        const cleanStringValue = (value) => {
          return (value && value.trim() !== '') ? value.trim() : null;
        };

        const requestData = {
          title: formData.title || (isEditMode ? '이력서' : `이력서 ${String(resumeCounter).padStart(2, '0')}`),
          industry: cleanStringValue(formData.industry),
          position: cleanStringValue(formData.position),
          targetCompany: cleanStringValue(formData.targetCompany),
          highlights: cleanStringValue(formData.highlights)
        };

        console.log('전송할 요청 데이터:', requestData);

        let resumeId;

        if (isEditMode) {
          const resumeResponse = await fetch(`/api/resumes/${currentResumeId}`, {
            method: 'PUT',
            headers: getCSRFHeaders(),
            body: JSON.stringify(requestData)
          });

          if (!resumeResponse.ok) {
            const errorText = await resumeResponse.text();
            console.error('Resume Update API Error:', {
              status: resumeResponse.status,
              statusText: resumeResponse.statusText,
              errorBody: errorText
            });
            throw new Error(`이력서 수정에 실패했습니다. (${resumeResponse.status}): ${errorText}`);
          }

          const resume = await resumeResponse.json();
          resumeId = resume.id;
        } else {
          const resumeResponse = await fetch('/api/resumes', {
            method: 'POST',
            headers: getCSRFHeaders(),
            body: JSON.stringify(requestData)
          });

          if (!resumeResponse.ok) {
            const errorText = await resumeResponse.text();
            console.error('Resume API Error:', {
              status: resumeResponse.status,
              statusText: resumeResponse.statusText,
              errorBody: errorText
            });
            throw new Error(`이력서 저장에 실패했습니다. (${resumeResponse.status}): ${errorText}`);
          }

          const resume = await resumeResponse.json();
          resumeId = resume.id;
        }

        // 고등학교 정보 저장
        if (formData.highschool.schoolName && formData.highschool.schoolName.trim() !== '') {
          await fetch(`/api/resumes/${resumeId}/educations`, {
            method: 'POST',
            headers: getCSRFHeaders(),
            body: JSON.stringify({
              type: 'HIGH_SCHOOL',
              schoolName: formData.highschool.schoolName.trim(),
              graduationDate: formData.highschool.graduationYear ? formData.highschool.graduationYear + '-03-01' : null,
              isCurrent: false
            })
          });
        }

        // 대학교 정보 저장
        for (const university of formData.universities) {
          if (university.schoolName && university.schoolName.trim() !== '') {
            await fetch(`/api/resumes/${resumeId}/educations`, {
              method: 'POST',
              headers: getCSRFHeaders(),
              body: JSON.stringify({
                type: 'UNIVERSITY',
                schoolName: university.schoolName.trim(),
                level: university.type || null,
                major: university.major || null,
                additionalMajor: university.additionalMajor || null,
                admissionDate: university.admissionDate || null,
                graduationDate: university.graduationDate || null,
                isCurrent: university.isCurrent || false
              })
            });
          }
        }

        // 대학원 정보 저장
        for (const graduate of formData.graduateSchools) {
          if (graduate.schoolName && graduate.schoolName.trim() !== '') {
            await fetch(`/api/resumes/${resumeId}/educations`, {
              method: 'POST',
              headers: getCSRFHeaders(),
              body: JSON.stringify({
                type: 'GRADUATE_SCHOOL',
                schoolName: graduate.schoolName.trim(),
                level: graduate.type || null,
                major: graduate.major || null,
                admissionDate: graduate.admissionDate || null,
                graduationDate: graduate.graduationDate || null,
                isCurrent: graduate.isCurrent || false
              })
            });
          }
        }

        // 경력 정보 저장
        for (const career of formData.careers) {
          if (career.companyName && career.companyName.trim() !== '') {
            await fetch(`/api/resumes/${resumeId}/careers`, {
              method: 'POST',
              headers: getCSRFHeaders(),
              body: JSON.stringify({
                companyName: career.companyName.trim(),
                department: career.department || null,
                positionTitle: career.positionTitle || null,
                startDate: career.startDate || null,
                endDate: career.endDate || null,
                isCurrent: career.isCurrent || false,
                responsibilities: career.responsibilities || null,
                resignationReason: career.resignationReason || null
              })
            });
          }
        }

        // 활동 정보 저장
        for (const experience of formData.experiences) {
          if (experience.activityName && experience.activityName.trim() !== '') {
            await fetch(`/api/resumes/${resumeId}/experiences`, {
              method: 'POST',
              headers: getCSRFHeaders(),
              body: JSON.stringify({
                activityName: experience.activityName.trim(),
                institution: experience.institution || null,
                startDate: experience.startDate || null,
                endDate: experience.endDate || null,
                isCurrent: experience.isCurrent || false,
                content: experience.content || null
              })
            });
          }
        }

        // Gemini를 통한 자소서 생성 요청
        const geminiResponse = await fetch(`/gemini/generate/${resumeId}`, {
          method: 'POST',
          headers: getCSRFHeaders()
        });

        if (!geminiResponse.ok) {
          console.warn('자소서 생성에 실패했지만 이력서는 저장되었습니다.');
        }

        alert(isEditMode ? '이력서가 성공적으로 수정되었습니다!' : '이력서가 성공적으로 저장되었습니다!');

        if (!isEditMode) {
          resumeCounter++;
        }

        window.location.href = `/resumes/result?resumeId=${resumeId}`;

      } catch (error) {
        console.error('Error:', error);
        if (error.name === 'SyntaxError' && error.message.includes('Unexpected token')) {
          alert('서버 응답 형식이 올바르지 않습니다. 관리자에게 문의하세요.');
        } else {
          alert(`${isEditMode ? '수정' : '저장'} 중 오류가 발생했습니다: ` + error.message);
        }
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = isEditMode ? 'AI 이력서 수정' : 'AI 이력서 생성';
      }
    }

    // 페이지 로드시 초기화
    document.addEventListener('DOMContentLoaded', init);
  </script>
</th:block>
</body>
</html>